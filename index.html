<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunea Master - Ciclo y Salud</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #f8fafc; color: #1e293b; font-family: 'Segoe UI', system-ui, sans-serif; }
        .day-cell { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .day-cell:active { transform: scale(0.90); }
        
        /* Estilos de Impresión para PDF */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; color: black; }
            #root { height: auto; overflow: visible; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>

    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <p style="color: #64748b;">Cargando Lunea Master...</p>
            <button onclick="localStorage.clear(); window.location.reload()" style="margin-top: 20px; padding: 10px; background: #ef4444; color: white; border-radius: 8px;">Restablecer si falla</button>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONOS ---
        const Icon = ({ path, className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const Icons = {
            Heart: (p) => <Icon {...p} path={<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />} />,
            Calendar: (p) => <Icon {...p} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></>} />,
            Settings: (p) => <Icon {...p} path={<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />} />,
            ChevronLeft: (p) => <Icon {...p} path={<polyline points="15 18 9 12 15 6" />} />,
            ChevronRight: (p) => <Icon {...p} path={<polyline points="9 18 15 12 9 6" />} />,
            Sun: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="5" /><line x1="12" y1="1" x2="12" y2="3" /><line x1="12" y1="21" x2="12" y2="23" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /><line x1="1" y1="12" x2="3" y2="12" /><line x1="21" y1="12" x2="23" y2="12" /><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" /></>} />,
            Moon: (p) => <Icon {...p} path={<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />} />,
            Droplet: (p) => <Icon {...p} path={<path d="M12 2.69l5.74 5.88a6 6 0 0 1-8.48 8.48A6 6 0 0 1 5.25 9.56L12 2.69z" />} />,
            Activity: (p) => <Icon {...p} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />} />,
            Smile: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10" /><path d="M8 14s1.5 2 4 2 4-2 4-2" /></>} />,
            Frown: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10" /><path d="M16 16s-1.5-2-4-2-4 2-4 2" /><line x1="9" y1="9" x2="9.01" y2="9" /><line x1="15" y1="9" x2="15.01" y2="9" /></>} />,
            Zap: (p) => <Icon {...p} path={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />} />,
            CloudRain: (p) => <Icon {...p} path={<><line x1="16" y1="13" x2="16" y2="21" /><line x1="8" y1="13" x2="8" y2="21" /><line x1="12" y1="15" x2="12" y2="23" /><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25" /></>} />,
            Thermometer: (p) => <Icon {...p} path={<path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z" />} />,
            Scale: (p) => <Icon {...p} path={<><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" /><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" /><path d="M7 21h10" /><path d="M12 3v18" /><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2" /></>} />,
            Pill: (p) => <Icon {...p} path={<><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z" /><path d="m8.5 8.5 7 7" /></>} />,
            CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></>} />,
            Eye: (p) => <Icon {...p} path={<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" /><circle cx="12" cy="12" r="3" /></>} />,
            EyeOff: (p) => <Icon {...p} path={<><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" /><line x1="1" y1="1" x2="23" y2="23" /></>} />,
            Users: (p) => <Icon {...p} path={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>} />,
            Trash: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></>} />,
            Lock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>} />,
            FileText: (p) => <Icon {...p} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></>} />,
            Palette: (p) => <Icon {...p} path={<><circle cx="13.5" cy="6.5" r=".5" /><circle cx="17.5" cy="10.5" r=".5" /><circle cx="8.5" cy="7.5" r=".5" /><circle cx="6.5" cy="12.5" r=".5" /><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z" /></>} />
        };

        const THEMES = {
            ROSE: { id: 'rose', primary: 'bg-rose-500', text: 'text-rose-600', light: 'bg-rose-50', ring: 'ring-rose-500' },
            TEAL: { id: 'teal', primary: 'bg-teal-500', text: 'text-teal-600', light: 'bg-teal-50', ring: 'ring-teal-500' },
            VIOLET: { id: 'violet', primary: 'bg-violet-500', text: 'text-violet-600', light: 'bg-violet-50', ring: 'ring-violet-500' },
            BLUE: { id: 'blue', primary: 'bg-blue-500', text: 'text-blue-600', light: 'bg-blue-50', ring: 'ring-blue-500' },
            ORANGE: { id: 'orange', primary: 'bg-orange-500', text: 'text-orange-600', light: 'bg-orange-50', ring: 'ring-orange-500' }
        };

        const SYMPTOMS_LIST = [
            { id: 'happy', label: 'Feliz', icon: Icons.Smile },
            { id: 'sad', label: 'Triste', icon: Icons.CloudRain },
            { id: 'irritable', label: 'Irritable', icon: Icons.Zap },
            { id: 'cramps', label: 'Cólicos', icon: Icons.Activity },
            { id: 'headache', label: 'Dolor', icon: Icons.Thermometer },
            { id: 'bloating', label: 'Hinchazón', icon: Icons.Droplet },
            { id: 'energetic', label: 'Energía', icon: Icons.Sun },
            { id: 'tired', label: 'Cansada', icon: Icons.Frown },
        ];

        const PinPad = ({ onUnlock, onSetPin, isSetting, onCancel }) => {
            const [input, setInput] = useState('');
            const handlePress = (n) => {
                const next = input + n;
                setInput(next);
                if(next.length === 4) {
                    if(isSetting) onSetPin(next);
                    else onUnlock(next);
                    setInput('');
                }
            };
            return (
                <div className="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center text-white">
                    <h2 className="text-xl font-bold mb-8">{isSetting ? 'Crea un PIN' : 'Introduce PIN'}</h2>
                    <div className="flex gap-4 mb-8">
                        {[0,1,2,3].map(i => <div key={i} className={`w-4 h-4 rounded-full ${input.length > i ? 'bg-white' : 'bg-slate-700'}`}></div>)}
                    </div>
                    <div className="grid grid-cols-3 gap-6">
                        {[1,2,3,4,5,6,7,8,9].map(n => <button key={n} onClick={() => handlePress(n.toString())} className="w-16 h-16 rounded-full bg-slate-800 text-2xl font-bold active:bg-indigo-600">{n}</button>)}
                        <div/>
                        <button onClick={() => handlePress('0')} className="w-16 h-16 rounded-full bg-slate-800 text-2xl font-bold active:bg-indigo-600">0</button>
                        <button onClick={() => isSetting && onCancel ? onCancel() : setInput('')} className="w-16 h-16 rounded-full flex items-center justify-center text-slate-400"><Icons.ChevronLeft className="w-8 h-8"/></button>
                    </div>
                </div>
            );
        };

        const SimpleChart = ({ data, colorClass, minVal, maxVal, isDark }) => {
            if (!data || data.length < 2) return <div className={`h-32 flex items-center justify-center text-xs rounded-xl border border-dashed ${isDark ? 'bg-slate-800 border-slate-700 text-slate-500' : 'bg-slate-50 border-slate-200 text-slate-400'}`}>Registra al menos 2 datos</div>;
            const points = data.map((d, i) => {
                const normalized = Math.max(0, Math.min(100, ((d.val - minVal) / (maxVal - minVal)) * 100));
                const y = 100 - normalized; 
                const x = (i / (data.length - 1)) * 100;
                return `${x},${y}`;
            }).join(' ');
            return (
                <div className="w-full h-32 relative mt-4">
                    <svg className="w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <line x1="0" y1="50" x2="100" y2="50" stroke={isDark ? "#334155" : "#f1f5f9"} strokeWidth="1" />
                        <polyline fill="none" stroke="currentColor" strokeWidth="2" points={points} className={`${colorClass}`} />
                        {data.map((d, i) => {
                            const y = 100 - Math.max(0, Math.min(100, ((d.val - minVal) / (maxVal - minVal)) * 100));
                            const x = (i / (data.length - 1)) * 100;
                            return <circle key={i} cx={x} cy={y} r="2.5" className={`stroke-current ${isDark ? 'fill-slate-900' : 'fill-white'} ${colorClass}`} strokeWidth="1.5" />;
                        })}
                    </svg>
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState(() => {
                try {
                    const saved = localStorage.getItem('lunea_master_db');
                    if (saved) return JSON.parse(saved);
                } catch(e) {}
                const uid = Date.now().toString();
                return {
                    currentUserId: uid,
                    users: [{
                        id: uid, name: 'Usuario Principal',
                        config: { lastPeriod: new Date().toISOString().split('T')[0], cycleLen: 28, periodLen: 5, regular: true, pill: false },
                        logs: {} 
                    }],
                    darkMode: false,
                    theme: 'rose',
                    pin: null
                };
            });

            const [locked, setLocked] = useState(!!db.pin);
            const [view, setView] = useState('calendar');
            const [selectedDay, setSelectedDay] = useState(null);
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [privacyMode, setPrivacyMode] = useState(false);
            const [showPinSetup, setShowPinSetup] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => localStorage.setItem('lunea_master_db', JSON.stringify(db)), [db]);

            const user = useMemo(() => db.users.find(u => u.id === db.currentUserId) || db.users[0], [db]);
            const currentTheme = THEMES[db.theme.toUpperCase()] || THEMES.ROSE;
            const darkMode = db.darkMode;

            useEffect(() => {
                if(darkMode) { document.body.classList.add('bg-slate-950', 'text-slate-100'); document.body.classList.remove('bg-slate-50', 'text-slate-800'); }
                else { document.body.classList.add('bg-slate-50', 'text-slate-800'); document.body.classList.remove('bg-slate-950', 'text-slate-100'); }
            }, [darkMode]);

            // LÓGICA
            const toKey = (d) => { const date=new Date(d); date.setHours(0,0,0,0); return new Date(date.getTime()-date.getTimezoneOffset()*60000).toISOString().split('T')[0]; };
            
            const activeCycleLength = user.config.cycleLen;

            const getCycleDay = (dateStr) => {
                const start = new Date(user.config.lastPeriod); start.setHours(0,0,0,0);
                const target = new Date(dateStr); target.setHours(0,0,0,0);
                if (target < start) return null;
                const diff = Math.floor((target - start) / 86400000);
                return (diff % activeCycleLength) + 1;
            };

            const getPhase = (day) => {
                if (!day) return null;
                const ov = activeCycleLength - 14;
                if (day <= user.config.periodLen) return { label: 'Menstruación', color: currentTheme.primary, text: currentTheme.text, light: currentTheme.light };
                if (day >= ov - 5 && day < ov) return { label: 'Fértil', color: 'bg-purple-400', text: 'text-purple-600', light: 'bg-purple-50' };
                if (day === ov) return { label: 'Ovulación', color: 'bg-purple-600', text: 'text-purple-700', light: 'bg-purple-100' };
                if (day > ov + 1) return { label: 'Lútea', color: 'bg-amber-400', text: 'text-amber-600', light: 'bg-amber-50' };
                if (day > user.config.periodLen && day < ov - 5) return { label: 'Folicular', color: 'bg-pink-300', text: 'text-pink-600', light: 'bg-pink-50' };
                return { label: 'Lútea', color: 'bg-amber-400', text: 'text-amber-600', light: 'bg-amber-50' };
            };

            const updateLog = (dateKey, field, value) => {
                const newLogs = { ...user.logs, [dateKey]: { ...(user.logs[dateKey] || {}), [field]: value } };
                setDb(prev => ({ ...prev, users: prev.users.map(u => u.id === prev.currentUserId ? { ...u, logs: newLogs } : u) }));
            };

            const updateConfig = (field, value) => {
                setDb(prev => ({ ...prev, users: prev.users.map(u => u.id === prev.currentUserId ? { ...u, config: { ...u.config, [field]: value } } : u) }));
            };

            // GESTIÓN
            const handleAddUser = () => {
                const name = prompt("Nombre:"); if(!name) return;
                const uid = Date.now().toString();
                setDb(p => ({...p, currentUserId: uid, users: [...p.users, { id: uid, name, config: user.config, logs: {} }]}));
            };

            const handleDeleteUser = (id) => {
                if(db.users.length <= 1) return alert("No puedes borrar el único usuario");
                if(confirm("¿Borrar usuario?")) setDb(p => ({ ...p, users: p.users.filter(u => u.id !== id), currentUserId: p.currentUserId === id ? p.users.find(u=>u.id!==id).id : p.currentUserId }));
            };

            const handleNewCycle = () => {
                if(confirm("¿Iniciar nuevo ciclo hoy?")) {
                    const today = toKey(new Date());
                    updateConfig('lastPeriod', today);
                    // Aquí se podría añadir lógica para guardar en historial
                    alert("Ciclo iniciado");
                }
            };

            const handleExport = () => {
                const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
                a.download = "lunea_backup.json"; a.click();
            };

            const handleImport = (e) => {
                const reader = new FileReader();
                reader.onload = (ev) => { try { setDb(JSON.parse(ev.target.result)); alert("Importado"); } catch(er) { alert("Error archivo"); } };
                reader.readAsText(e.target.files[0]);
            };

            // VISTAS
            if (locked) return <PinPad onUnlock={(code) => code === db.pin ? setLocked(false) : alert("PIN Incorrecto")} isSetting={false} />;
            if (showPinSetup) return <PinPad isSetting={true} onSetPin={(code) => { setDb(p => ({...p, pin: code})); setShowPinSetup(false); alert("PIN Guardado"); }} onCancel={() => setShowPinSetup(false)} />;

            if (view === 'pdf') {
                return (
                    <div className="bg-white text-black p-8 min-h-screen">
                        <div className="flex justify-between items-center mb-8 border-b pb-4">
                            <h1 className="text-3xl font-bold text-rose-600">Reporte Médico Lunea</h1>
                            <div className="text-right"><p className="text-sm text-gray-500">{new Date().toLocaleDateString()}</p><p className="font-bold">{user.name}</p></div>
                        </div>
                        <div className="mb-8 p-4 bg-gray-50 rounded-xl">
                            <h2 className="font-bold mb-2">Resumen</h2>
                            <p>Ciclo promedio: {activeCycleLength} días | Último periodo: {user.config.lastPeriod}</p>
                        </div>
                        <table className="w-full text-sm text-left">
                            <thead><tr className="border-b"><th className="py-2">Fecha</th><th>Fase</th><th>Síntomas</th><th>Notas</th></tr></thead>
                            <tbody>
                                {Object.keys(user.logs).sort().reverse().slice(0, 20).map(d => (
                                    <tr key={d} className="border-b">
                                        <td className="py-2">{d}</td>
                                        <td>{getPhase(getCycleDay(d))?.label}</td>
                                        <td>{(user.logs[d].symptoms || []).join(', ')}</td>
                                        <td>{user.logs[d].temp ? `T:${user.logs[d].temp}` : ''}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        <div className="mt-8 text-center no-print"><button onClick={() => window.print()} className="bg-black text-white px-6 py-2 rounded-lg">Imprimir / Guardar PDF</button> <button onClick={() => setView('calendar')} className="ml-4 underline">Volver</button></div>
                    </div>
                );
            }

            const renderCalendar = () => {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();
                const daysInMonth = new Date(year, month+1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                const days = [];
                for(let i=0; i<firstDay; i++) days.push(<div key={`e-${i}`}></div>);
                for(let i=1; i<=daysInMonth; i++) {
                    const d = new Date(year, month, i);
                    const k = toKey(d);
                    const cd = getCycleDay(k);
                    const p = getPhase(cd);
                    const log = user.logs[k] || {};
                    const isToday = k === toKey(new Date());
                    
                    let bg = darkMode ? 'hover:bg-slate-800' : 'hover:bg-slate-50';
                    let text = darkMode ? 'text-slate-400' : 'text-slate-500';
                    if (p) { bg = privacyMode ? (darkMode ? 'bg-slate-800' : 'bg-slate-100') : (darkMode ? 'bg-slate-800' : p.light); text = privacyMode ? 'text-slate-400' : p.text; }

                    days.push(
                        <button key={k} onClick={() => setSelectedDay({date: d, k, p, cd})} 
                            className={`day-cell h-16 rounded-xl relative flex flex-col items-center justify-center border border-transparent ${bg} ${isToday ? `ring-2 ${currentTheme.ring} z-10` : ''}`}>
                            {cd && <span className={`absolute top-1 right-1.5 text-[10px] font-bold opacity-60 ${text}`}>{cd}</span>}
                            <span className={`text-lg font-bold ${text}`}>{i}</span>
                            <div className="absolute bottom-1.5 flex gap-1">
                                {p && <div className={`w-1.5 h-1.5 rounded-full ${privacyMode ? 'bg-slate-400' : p.color}`}></div>}
                                {(log.water>0 || log.sleep) && <div className="w-1.5 h-1.5 rounded-full bg-blue-400"></div>}
                            </div>
                        </button>
                    );
                }
                return (
                    <div className={`p-4 rounded-3xl mb-6 ${darkMode ? 'bg-slate-900' : 'bg-white shadow-sm'}`}>
                        <div className="flex justify-between items-center mb-4">
                            <button onClick={() => setCurrentMonth(new Date(year, month-1))} className="p-2"><Icons.ChevronLeft className="w-6 h-6"/></button>
                            <span className="font-bold capitalize">{currentMonth.toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</span>
                            <button onClick={() => setCurrentMonth(new Date(year, month+1))} className="p-2"><Icons.ChevronRight className="w-6 h-6"/></button>
                        </div>
                        <div className="grid grid-cols-7 text-center text-xs opacity-40 font-bold mb-2"><span>DO</span><span>LU</span><span>MA</span><span>MI</span><span>JU</span><span>VI</span><span>SA</span></div>
                        <div className="grid grid-cols-7 gap-2">{days}</div>
                    </div>
                );
            };

            const renderSettings = () => (
                <div className={`p-6 max-w-md mx-auto animate-in ${darkMode ? 'text-white' : 'text-slate-800'}`}>
                    <div className="flex justify-between items-center mb-6"><button onClick={() => setView('calendar')}><Icons.ChevronLeft className="w-6 h-6"/></button><h2 className="text-xl font-bold">Ajustes</h2><div/></div>

                    <div className={`p-4 rounded-2xl mb-4 ${darkMode ? 'bg-slate-900' : 'bg-white shadow-sm'}`}>
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold flex gap-2 items-center"><Icons.Users className="w-4 h-4"/> Usuarios</h3><button onClick={handleAddUser}><Icons.Plus className="w-5 h-5"/></button></div>
                        {db.users.map(u => (
                            <div key={u.id} className={`flex justify-between p-3 rounded-lg mb-2 ${u.id === db.currentUserId ? (darkMode ? 'bg-slate-800' : 'bg-slate-50 border') : ''}`}>
                                <button onClick={() => setDb({...db, currentUserId: u.id})} className="text-sm font-medium text-left flex-1">{u.name}</button>
                                {u.id !== db.currentUserId && <button onClick={() => handleDeleteUser(u.id)} className="text-red-400"><Icons.Trash className="w-4 h-4"/></button>}
                            </div>
                        ))}
                    </div>

                    <div className={`p-4 rounded-2xl mb-4 ${darkMode ? 'bg-slate-900' : 'bg-white shadow-sm'}`}>
                        <h3 className="font-bold mb-4">Ciclo Actual</h3>
                        <div className="space-y-4 text-sm">
                            <div><label className="block opacity-60 text-xs mb-1">Inicio (Editable)</label><input type="date" value={user.config.lastPeriod} onChange={(e) => updateConfig('lastPeriod', e.target.value)} className={`w-full p-2 rounded ${darkMode ? 'bg-slate-800' : 'bg-slate-50 border'}`}/></div>
                            <button onClick={handleNewCycle} className={`w-full py-2 rounded font-bold text-white ${currentTheme.primary}`}>Iniciar Nuevo Ciclo Hoy</button>
                            <div className="flex gap-4 pt-2">
                                <div className="flex-1"><label className="block opacity-60 text-xs mb-1">Duración</label><input type="number" value={user.config.cycleLen} onChange={(e) => updateConfig('cycleLen', parseInt(e.target.value))} className={`w-full p-2 rounded ${darkMode ? 'bg-slate-800' : 'bg-slate-50 border'}`}/></div>
                                <div className="flex-1"><label className="block opacity-60 text-xs mb-1">Sangrado</label><input type="number" value={user.config.periodLen} onChange={(e) => updateConfig('periodLen', parseInt(e.target.value))} className={`w-full p-2 rounded ${darkMode ? 'bg-slate-800' : 'bg-slate-50 border'}`}/></div>
                            </div>
                        </div>
                    </div>

                    <div className={`p-4 rounded-2xl mb-4 ${darkMode ? 'bg-slate-900' : 'bg-white shadow-sm'}`}>
                        <h3 className="font-bold mb-3">Apariencia y Seguridad</h3>
                        <div className="flex gap-2 mb-4">{Object.values(THEMES).map(t => <button key={t.id} onClick={() => setDb({...db, theme: t.id})} className={`w-6 h-6 rounded-full ${t.primary} ${db.theme === t.id ? 'ring-2 ring-slate-400' : ''}`}></button>)}</div>
                        {db.pin ? <button onClick={() => setDb({...db, pin: null})} className="text-red-500 text-sm">Quitar PIN</button> : <button onClick={() => setShowPinSetup(true)} className="text-indigo-500 text-sm font-bold">Poner PIN</button>}
                    </div>

                    <div className="grid grid-cols-2 gap-3 mb-8">
                        <button onClick={handleExport} className={`py-3 rounded-xl text-xs font-bold border flex items-center justify-center gap-2 ${darkMode ? 'border-slate-700' : 'border-slate-200'}`}><Icons.Download className="w-4 h-4"/> Exportar JSON</button>
                        <button onClick={() => fileInputRef.current.click()} className={`py-3 rounded-xl text-xs font-bold border flex items-center justify-center gap-2 ${darkMode ? 'border-slate-700' : 'border-slate-200'}`}><Icons.Upload className="w-4 h-4"/> Importar</button>
                        <input type="file" ref={fileInputRef} onChange={handleImport} className="hidden" accept=".json"/>
                    </div>
                </div>
            );

            // MAIN RENDER
            return (
                <div className={`min-h-screen pb-20 ${darkMode ? 'bg-slate-950 text-white' : 'bg-slate-50 text-slate-800'}`}>
                    {view === 'calendar' && (
                        <header className="px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-2"><div className={currentTheme.text}><Icons.Heart className="w-6 h-6 fill-current"/></div><h1 className="text-xl font-bold tracking-tight">Lunea</h1></div>
                            <div className="flex gap-3">
                                <button onClick={() => setDb({...db, darkMode: !db.darkMode})}>{darkMode ? <Icons.Sun className="w-6 h-6"/> : <Icons.Moon className="w-6 h-6"/>}</button>
                                <button onClick={() => setPrivacyMode(!privacyMode)} className={privacyMode ? 'text-indigo-500' : ''}>{privacyMode ? <Icons.EyeOff className="w-6 h-6"/> : <Icons.Eye className="w-6 h-6"/>}</button>
                                <button onClick={() => setView('settings')}><Icons.Settings className="w-6 h-6"/></button>
                            </div>
                        </header>
                    )}

                    {view === 'calendar' ? (
                        <div className="max-w-md mx-auto p-4">
                            <div className={`relative overflow-hidden rounded-[2rem] p-6 mb-6 text-center shadow-sm border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-100'}`}>
                                <h2 className="text-xs font-bold uppercase tracking-widest opacity-50 mb-2">{new Date().toLocaleDateString('es-ES', {weekday:'long', day:'numeric', month:'long'})}</h2>
                                <div className="my-4"><span className="text-6xl font-black">{getCycleDay(toKey(new Date())) || '?'}</span><br/><span className="text-sm font-medium opacity-50">Día del Ciclo</span></div>
                                <div className={`inline-flex items-center px-4 py-2 rounded-full text-sm font-bold ${getPhase(getCycleDay(toKey(new Date())))?.light || 'bg-gray-100'} ${getPhase(getCycleDay(toKey(new Date())))?.text || 'text-gray-500'}`}>{getPhase(getCycleDay(toKey(new Date())))?.label || 'Sin datos'}</div>
                            </div>
                            {renderCalendar()}
                        </div>
                    ) : view === 'report' ? (
                        <div className="max-w-md mx-auto p-6 space-y-6 animate-in">
                            <div className="flex justify-between items-center"><button onClick={() => setView('calendar')}><Icons.ChevronLeft className="w-6 h-6"/></button><h2 className="text-xl font-bold">Salud</h2></div>
                            <div className={`p-6 rounded-3xl shadow-sm border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-100'}`}>
                                <h3 className="font-bold mb-4 flex gap-2"><Icons.FileText className="w-5 h-5"/> Reporte Médico</h3>
                                <button onClick={() => setView('pdf')} className={`w-full py-3 rounded-xl font-bold ${currentTheme.light} ${currentTheme.text}`}>Ver PDF para Imprimir</button>
                            </div>
                            <div className={`p-6 rounded-3xl shadow-sm border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-100'}`}>
                                <h3 className="font-bold mb-2">Temperatura</h3>
                                <SimpleChart data={Object.keys(user.logs).sort().slice(-14).map(k=>({val: user.logs[k].temp})).filter(x=>x.val)} colorClass="text-rose-400" minVal={35.5} maxVal={37.5} isDark={darkMode}/>
                            </div>
                        </div>
                    ) : renderSettings()}

                    {view !== 'pdf' && (
                        <div className={`fixed bottom-0 w-full p-2 border-t ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-100'} flex justify-around no-print`}>
                            <button onClick={() => setView('calendar')} className={`flex-1 py-3 flex justify-center ${view === 'calendar' ? currentTheme.text : 'opacity-50'}`}><Icons.Calendar className="w-6 h-6"/></button>
                            <button onClick={() => setView('report')} className={`flex-1 py-3 flex justify-center ${view === 'report' ? currentTheme.text : 'opacity-50'}`}><Icons.Activity className="w-6 h-6"/></button>
                        </div>
                    )}

                    {selectedDay && (
                        <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4" onClick={() => setSelectedDay(null)}>
                            <div className={`w-full md:max-w-sm rounded-t-3xl md:rounded-3xl p-6 h-[85vh] md:h-auto overflow-y-auto ${darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-800'}`} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6"><h3 className="text-2xl font-bold capitalize">{selectedDay.date.toLocaleDateString('es-ES', {weekday:'long', day:'numeric'})}</h3><button onClick={() => setSelectedDay(null)} className="p-2 bg-gray-100 rounded-full text-black">✕</button></div>
                                
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div className={`p-4 rounded-2xl flex flex-col items-center ${darkMode ? 'bg-blue-900/30' : 'bg-blue-50'}`}>
                                        <div className="text-blue-500 font-bold text-xs mb-2 flex items-center gap-1"><Icons.Droplet className="w-4 h-4"/> AGUA</div>
                                        <div className="flex items-center gap-3">
                                            <button onClick={() => updateLog(selectedDay.k, 'water', Math.max(0, (user.logs[selectedDay.k]?.water||0)-1))} className="w-8 h-8 rounded-full bg-white text-blue-500 shadow font-bold">-</button>
                                            <span className="text-xl font-bold">{user.logs[selectedDay.k]?.water||0}</span>
                                            <button onClick={() => updateLog(selectedDay.k, 'water', (user.logs[selectedDay.k]?.water||0)+1)} className="w-8 h-8 rounded-full bg-blue-500 text-white shadow font-bold">+</button>
                                        </div>
                                    </div>
                                    <div className={`p-4 rounded-2xl flex flex-col items-center ${darkMode ? 'bg-indigo-900/30' : 'bg-indigo-50'}`}>
                                        <div className="text-indigo-500 font-bold text-xs mb-2 flex items-center gap-1"><Icons.Moon className="w-4 h-4"/> SUEÑO</div>
                                        <div className="flex items-center gap-3">
                                            <button onClick={() => updateLog(selectedDay.k, 'sleep', Math.max(0, (user.logs[selectedDay.k]?.sleep||0)-1))} className="w-8 h-8 rounded-full bg-white text-indigo-500 shadow font-bold">-</button>
                                            <span className="text-xl font-bold">{user.logs[selectedDay.k]?.sleep||0}h</span>
                                            <button onClick={() => updateLog(selectedDay.k, 'sleep', (user.logs[selectedDay.k]?.sleep||0)+1)} className="w-8 h-8 rounded-full bg-indigo-500 text-white shadow font-bold">+</button>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-4 mb-4">
                                    {user.config.pill && (
                                        <button onClick={() => updateLog(selectedDay.k, 'pill', !user.logs[selectedDay.k]?.pill)} className={`flex-1 p-4 rounded-2xl flex items-center justify-center gap-2 border ${user.logs[selectedDay.k]?.pill ? 'bg-green-100 border-green-500 text-green-700' : (darkMode ? 'border-slate-700' : 'border-slate-200')}`}>
                                            {user.logs[selectedDay.k]?.pill ? <Icons.CheckCircle className="w-5 h-5"/> : <Icons.Pill className="w-5 h-5"/>} <span className="font-bold text-sm">Pastilla</span>
                                        </button>
                                    )}
                                    <div className={`flex-1 p-4 rounded-2xl flex items-center justify-between border ${darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                                        <Icons.Scale className="w-5 h-5 opacity-50"/>
                                        <input type="number" placeholder="Kg" value={user.logs[selectedDay.k]?.weight || ''} onChange={(e) => updateLog(selectedDay.k, 'weight', e.target.value)} className="w-16 bg-transparent text-right font-bold focus:outline-none"/>
                                    </div>
                                </div>

                                <div className={`p-4 rounded-2xl mb-4 flex items-center justify-between border ${darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                                    <div className="flex gap-2 items-center text-sm font-bold text-rose-400"><Icons.Thermometer className="w-5 h-5"/> Temperatura</div>
                                    <input type="number" step="0.1" placeholder="36.5" value={user.logs[selectedDay.k]?.temp || ''} onChange={(e) => updateLog(selectedDay.k, 'temp', e.target.value)} className="w-20 bg-transparent text-right font-bold text-lg focus:outline-none"/>
                                </div>

                                <div className="grid grid-cols-4 gap-2">
                                    {SYMPTOMS_LIST.map(s => {
                                        const active = (user.logs[selectedDay.k]?.symptoms || []).includes(s.id);
                                        return (
                                            <button key={s.id} onClick={() => {
                                                const current = user.logs[selectedDay.k]?.symptoms || [];
                                                const newS = active ? current.filter(x => x !== s.id) : [...current, s.id];
                                                updateLog(selectedDay.k, 'symptoms', newS);
                                            }} className={`p-3 rounded-xl border flex flex-col items-center gap-1 ${active ? `${currentTheme.light} ${currentTheme.text} border-transparent` : (darkMode ? 'border-slate-700 text-slate-500' : 'border-slate-100 text-slate-400')}`}>
                                                <s.icon className="w-6 h-6"/>
                                                <span className="text-[10px] font-medium">{s.label}</span>
                                            </button>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    <footer className="text-center py-6 text-xs opacity-40 no-print"><p>Creado por Juan Miguel Rios Redondo</p></footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

