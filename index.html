<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunea - Tu Gu√≠a</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f8fafc; color: #1e293b; font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .day-cell:active { transform: scale(0.95); transition: 0.1s; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
            #app { height: auto; overflow: visible; }
        }
    </style>
</head>
<body>

    <!-- CONTENEDOR PRINCIPAL -->
    <div id="app" class="min-h-screen pb-24 relative"></div>

    <!-- PANTALLA DE ERROR -->
    <div id="error-screen" class="hidden fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center p-8 text-center">
        <h2 class="text-red-500 font-bold text-xl mb-4">Error Cr√≠tico</h2>
        <button onclick="hardReset()" class="bg-red-500 text-white px-6 py-3 rounded-lg font-bold">Reiniciar de F√°brica</button>
    </div>

    <!-- L√ìGICA NATIVA -->
    <script>
        // --- ICONOS ---
        const ICONS = {
            heart: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 fill-current" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>',
            calendar: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
            settings: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
            left: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>',
            right: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>',
            activity: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
            grid: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>',
            droplet: '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.74 5.88a6 6 0 0 1-8.48 8.48A6 6 0 0 1 5.25 9.56L12 2.69z"/></svg>',
            moon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
            sun: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>',
            pill: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="6" ry="6"/></svg>',
            check: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
            users: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>',
            trash: '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
            edit: '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
            plus: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
            close: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
            file: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
            thermo: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>',
            scale: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>',
            sparkles: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M19 21v-4"/><path d="M15 19h4"/></svg>',
            
            // SINTOMAS
            smile: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/></svg>',
            frown: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M16 16s-1.5-2-4-2-4 2-4 2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>',
            zap: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
            cloud: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="16" y1="13" x2="16" y2="21"/><line x1="8" y1="13" x2="8" y2="21"/><line x1="12" y1="15" x2="12" y2="23"/><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg>'
        };

        // --- ESTADO ---
        const DB_KEY = 'lunea_v55_tutorial';
        let tutorialStep = 0; // Control local del tutorial

        let state = {
            view: 'calendar',
            currentMonth: new Date(),
            viewYear: new Date().getFullYear(),
            selectedDate: null,
            users: [{ id: '1', name: 'Yo', config: { lastPeriod: new Date().toISOString().split('T')[0], cycleLen: 28, periodLen: 5, pill: false }, logs: {} }],
            currentUserId: '1',
            showTutorial: true // Inicia true
        };

        // Cargar
        try {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed, currentMonth: new Date(), viewYear: new Date().getFullYear(), selectedDate: null };
            }
        } catch(e) { console.log('Error carga:', e); }

        // --- L√ìGICA ---
        function save() { localStorage.setItem(DB_KEY, JSON.stringify(state)); render(); }
        function getUser() { return state.users.find(u => u.id === state.currentUserId) || state.users[0]; }
        
        function toKey(d) { const o = d.getTimezoneOffset() * 60000; return new Date(d.getTime() - o).toISOString().split('T')[0]; }

        function getCycleDay(dateStr) {
            const user = getUser();
            const start = new Date(user.config.lastPeriod + 'T00:00:00');
            const target = new Date(dateStr + 'T00:00:00');
            if (target < start) return null;
            const diff = Math.floor((target - start) / 86400000);
            return (diff % user.config.cycleLen) + 1;
        }

        function getPhase(dateStr) {
            const cd = getCycleDay(dateStr);
            const user = getUser();
            if (!cd) return null;
            const ov = user.config.cycleLen - 14;
            if (cd <= user.config.periodLen) return {l:'Menstruaci√≥n', bg:'bg-rose-500', t:'text-rose-600', light:'bg-rose-100'};
            if (cd >= ov - 5 && cd < ov) return {l:'F√©rtil', bg:'bg-purple-400', t:'text-purple-600', light:'bg-purple-100'};
            if (cd === ov) return {l:'Ovulaci√≥n', bg:'bg-purple-600', t:'text-purple-700', light:'bg-purple-200'};
            if (cd > ov) return {l:'L√∫tea', bg:'bg-amber-400', t:'text-amber-600', light:'bg-amber-100'};
            return {l:'Folicular', bg:'bg-pink-300', t:'text-pink-600', light:'bg-pink-50'};
        }

        // --- ACCIONES GLOBAL ---
        window.hardReset = () => { localStorage.clear(); location.reload(); };
        window.setView = (v) => { state.view = v; render(); };
        window.closeModal = () => { state.selectedDate = null; render(); };
        window.setMonth = (delta) => { state.currentMonth.setMonth(state.currentMonth.getMonth() + delta); render(); };
        window.setYear = (delta) => { state.viewYear += delta; render(); };
        window.selectDate = (k) => { state.selectedDate = k; render(); };
        
        window.updateLog = (key, field, val) => {
            const user = getUser();
            if (!user.logs[key]) user.logs[key] = {};
            if (field === 'water' || field === 'sleep') {
                let current = user.logs[key][field] || 0;
                if (val === 'inc') current++; else if (val === 'dec') current = Math.max(0, current - 1);
                user.logs[key][field] = current;
            } else if (field === 'pill') { user.logs[key].pill = !user.logs[key].pill; }
            else if (field === 'symptoms') {
                let current = user.logs[key].symptoms || [];
                if(current.includes(val)) current = current.filter(s => s !== val); else current.push(val);
                user.logs[key].symptoms = current;
            }
            else { user.logs[key][field] = val; }
            save();
        };

        window.updateConfig = (field, val) => {
            const user = getUser();
            if(field !== 'lastPeriod' && field !== 'pill') val = parseInt(val);
            if(field === 'pill') val = val === 'true'; 
            user.config[field] = val;
            save();
        };

        window.addUser = () => { const n = prompt("Nombre:"); if (n) { const id = Date.now().toString(); state.users.push({ id, name: n, config: {...getUser().config}, logs: {} }); state.currentUserId = id; save(); } };
        window.switchUser = (id) => { state.currentUserId = id; save(); };
        window.deleteUser = (id) => { if(state.users.length <= 1) return alert("M√≠nimo un usuario"); if(confirm("¬øBorrar?")) { state.users = state.users.filter(u => u.id !== id); state.currentUserId = state.users[0].id; save(); } };
        window.editUser = (id) => { const u = state.users.find(u => u.id === id); const n = prompt("Nuevo nombre:", u.name); if (n) { u.name = n; save(); } };
        
        // TUTORIAL LOGIC
        window.nextSlide = () => {
            tutorialStep++;
            render();
        };
        window.endTutorial = () => {
            state.showTutorial = false;
            tutorialStep = 0;
            save();
        };
        window.openTutorial = () => {
            state.showTutorial = true;
            tutorialStep = 0;
            render();
        }

        // --- RENDERIZADO ---
        function render() {
            const app = document.getElementById('app');
            let html = '';

            // TUTORIAL WIZARD
            if (state.showTutorial) {
                const slides = [
                    { t: "Bienvenida a Lunea", d: "Tu espacio privado para conocer tu ciclo. Sin internet, 100% seguro en tu dispositivo.", i: ICONS.heart, c: "text-rose-500 bg-rose-100" },
                    { t: "Los Colores del Ciclo", d: `
                        <ul class="text-left text-sm space-y-2 bg-slate-50 p-4 rounded-xl">
                            <li class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-rose-500"></div> <b>Rojo (Menstruaci√≥n):</b> D√≠as de sangrado.</li>
                            <li class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-pink-400"></div> <b>Rosa (Folicular):</b> Energ√≠a subiendo.</li>
                            <li class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-purple-400"></div> <b>Morado (F√©rtil):</b> Alta probabilidad de embarazo.</li>
                            <li class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-amber-400"></div> <b>√Åmbar (L√∫tea):</b> Preparaci√≥n pre-menstrual.</li>
                        </ul>
                    `, i: ICONS.droplet, c: "text-indigo-500 bg-indigo-100" },
                    { t: "Funciones Principales", d: `
                         <div class="text-left text-sm space-y-2 bg-slate-50 p-4 rounded-xl">
                            <p><b>üìÖ Calendario:</b> Toca un d√≠a para registrar s√≠ntomas y ver predicciones.</p>
                            <p><b>üìä Salud:</b> Gr√°ficos de temperatura, peso y reporte m√©dico PDF.</p>
                            <p><b>‚öôÔ∏è Ajustes:</b> Crea usuarios (para ti o tu hija) y haz copias de seguridad.</p>
                         </div>
                    `, i: ICONS.settings, c: "text-teal-500 bg-teal-100" },
                    { t: "¬°Todo Listo!", d: "Ya puedes empezar a registrar tu ciclo.", i: ICONS.check, c: "text-green-500 bg-green-100" }
                ];
                
                const slide = slides[tutorialStep];
                
                app.innerHTML = `
                    <div class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-8 text-center fade-in">
                        <div class="p-6 rounded-full mb-6 ${slide.c.split(' ')[1]} ${slide.c.split(' ')[0]}">${slide.i}</div>
                        <h2 class="text-2xl font-bold mb-4 text-slate-800">${slide.t}</h2>
                        <div class="text-slate-500 mb-8 w-full max-w-xs">${slide.d}</div>
                        <div class="flex gap-2 mb-8">
                            ${slides.map((_,i) => `<div class="h-2 rounded-full transition-all duration-300 ${i===tutorialStep ? 'w-8 bg-slate-800' : 'w-2 bg-slate-200'}"></div>`).join('')}
                        </div>
                        <button onclick="${tutorialStep < slides.length - 1 ? 'nextSlide()' : 'endTutorial()'}" class="w-full max-w-xs py-3 bg-slate-900 text-white rounded-xl font-bold shadow-lg">
                            ${tutorialStep < slides.length - 1 ? 'Siguiente' : 'Empezar'}
                        </button>
                    </div>
                `;
                return;
            }

            // PDF
            if (state.view === 'pdf') {
                const user = getUser();
                const logs = Object.keys(user.logs).sort().reverse().slice(0, 30);
                const rows = logs.map(k => {
                    const log = user.logs[k];
                    return `<tr class="border-b"><td class="py-2">${k}</td><td>${getCycleDay(k)}</td><td>${getPhase(k)?.l}</td><td>${(log.symptoms||[]).length}</td><td class="italic text-gray-500">${log.notes||'-'}</td></tr>`;
                }).join('');

                app.innerHTML = `
                    <div class="bg-white text-black p-8 min-h-screen">
                        <h1 class="text-2xl font-bold text-rose-600 mb-4">Reporte M√©dico</h1>
                        <p class="mb-4">Paciente: ${user.name} | Ciclo: ${user.config.cycleLen} d√≠as</p>
                        <table class="w-full text-sm text-left border-collapse">
                            <thead><tr class="border-b bg-gray-50"><th class="p-2">Fecha</th><th>D√≠a</th><th>Fase</th><th>S√≠nt.</th><th>Notas</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                        <div class="mt-8 no-print text-center"><button onclick="window.print()" class="bg-black text-white px-6 py-2 rounded font-bold">Imprimir</button><button onclick="setView('report')" class="ml-4 underline">Volver</button></div>
                    </div>
                `;
                return;
            }

            // --- LAYOUT APP ---
            html += `<div class="px-6 py-4 flex justify-between items-center bg-white shadow-sm sticky top-0 z-20">
                <div class="flex items-center gap-2 text-rose-500">${ICONS.heart} <h1 class="text-xl font-bold text-slate-800">Lunea</h1></div>
                <button onclick="setView('settings')" class="text-slate-400 p-2">${ICONS.settings}</button>
            </div>`;

            // CALENDARIO
            if (state.view === 'calendar') {
                const user = getUser();
                const year = state.currentMonth.getFullYear();
                const month = state.currentMonth.getMonth();
                const startDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const todayK = toKey(new Date());
                const todayCD = getCycleDay(todayK);
                const todayP = getPhase(todayK);

                let daysHtml = '';
                for(let i=0; i<startDay; i++) daysHtml += `<div></div>`;
                for(let i=1; i<=daysInMonth; i++) {
                    const d = new Date(year, month, i);
                    const k = toKey(d);
                    const cd = getCycleDay(k);
                    const p = getPhase(k);
                    const isToday = k === todayK;
                    const log = user.logs[k] || {};
                    
                    let dots = '';
                    if(p) dots += `<div class="w-1.5 h-1.5 rounded-full ${p.bg}"></div>`;
                    if(log.water || log.sleep) dots += `<div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div>`;
                    if(log.symptoms && log.symptoms.length > 0) dots += `<div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>`;

                    daysHtml += `
                        <button onclick="selectDate('${k}')" class="h-16 rounded-xl flex flex-col items-center justify-center relative day-cell border ${isToday ? 'border-rose-500 border-2' : 'border-slate-100'} ${p ? p.light : 'bg-white'}">
                            ${cd ? `<span class="absolute top-1 right-1 text-[10px] font-bold text-slate-400 font-mono">${cd}</span>` : ''}
                            <span class="text-sm font-bold ${p ? p.t : 'text-slate-600'}">${i}</span>
                            <div class="flex gap-0.5 mt-1">${dots}</div>
                        </button>
                    `;
                }

                html += `
                    <div class="p-4 max-w-md mx-auto animate-in">
                        <div class="rounded-[2rem] p-6 mb-6 text-center bg-white shadow-sm border border-slate-100">
                            <h2 class="text-xs font-bold uppercase text-slate-400 mb-2">${new Date().toLocaleDateString('es-ES', {weekday:'long', day:'numeric'})}</h2>
                            <div class="text-5xl font-black text-slate-800 mb-1">${todayCD || '?'}</div>
                            <div class="text-sm text-slate-500 mb-4">D√≠a del Ciclo</div>
                            ${todayCD ? `<div class="inline-block px-4 py-1 rounded-full text-sm font-bold ${todayP.light} ${todayP.t}">${todayP.l}</div>` : `<button onclick="setView('settings')" class="bg-rose-500 text-white px-4 py-2 rounded animate-pulse">Configurar Inicio</button>`}
                        </div>
                        <div class="p-4 bg-white rounded-3xl shadow-sm mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <button onclick="setMonth(-1)" class="p-2 text-slate-400">${ICONS.left}</button>
                                <div class="text-center"><div class="font-bold capitalize">${state.currentMonth.toLocaleDateString('es-ES', {month:'long', year:'numeric'})}</div><button onclick="goToToday()" class="text-[10px] text-rose-500 font-bold">HOY</button></div>
                                <button onclick="setMonth(1)" class="p-2 text-slate-400">${ICONS.right}</button>
                            </div>
                            <div class="grid grid-cols-7 text-center text-xs text-slate-400 font-bold mb-2"><span>D</span><span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span></div>
                            <div class="grid grid-cols-7 gap-1">${daysHtml}</div>
                        </div>
                    </div>
                `;
            }

            // VISTA ANUAL
            else if (state.view === 'year') {
                let monthsHtml = '';
                for(let m=0; m<12; m++) {
                    const daysInM = new Date(state.viewYear, m+1, 0).getDate();
                    let dots = '';
                    for(let d=1; d<=daysInM; d++) {
                        const k = toKey(new Date(state.viewYear, m, d));
                        const p = getPhase(k);
                        dots += `<div class="w-1.5 h-1.5 rounded-full ${p ? p.bg : 'bg-slate-100'}"></div>`;
                    }
                    monthsHtml += `<div class="p-1 border rounded bg-white"><div class="font-bold text-[8px] text-center mb-1">${new Date(state.viewYear, m).toLocaleDateString('es-ES',{month:'short'})}</div><div class="flex flex-wrap gap-[1px] justify-center">${dots}</div></div>`;
                }
                html += `
                    <div class="p-4 max-w-md mx-auto animate-in mb-24">
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="setView('calendar')">${ICONS.left}</button>
                            <div class="flex gap-4 items-center"><button onclick="setYear(-1)">${ICONS.left}</button><h2 class="text-xl font-bold">${state.viewYear}</h2><button onclick="setYear(1)">${ICONS.right}</button></div><div class="w-6"></div>
                        </div>
                        <div class="grid grid-cols-3 gap-2">${monthsHtml}</div>
                    </div>
                `;
            }

            // AJUSTES
            else if (state.view === 'settings') {
                const user = getUser();
                let usersHtml = state.users.map(u => `<div class="flex justify-between items-center py-2 border-b"><button onclick="switchUser('${u.id}')" class="${u.id===state.currentUserId?'text-rose-500 font-bold':''}">${u.name}</button><div class="flex gap-2"><button onclick="editUser('${u.id}')" class="text-slate-400">${ICONS.edit}</button>${state.users.length>1?`<button onclick="deleteUser('${u.id}')" class="text-red-400">${ICONS.trash}</button>`:''}</div></div>`).join('');
                html += `
                    <div class="p-6 max-w-md mx-auto animate-in">
                        <div class="flex justify-between mb-6"><button onclick="setView('calendar')">${ICONS.left}</button><h2 class="text-xl font-bold">Ajustes</h2><div></div></div>
                        <div class="bg-white p-4 rounded-xl shadow-sm mb-4"><div class="flex justify-between mb-4 font-bold"><h3>Usuarios</h3><button onclick="addUser()" class="text-rose-500">${ICONS.plus}</button></div>${usersHtml}</div>
                        <div class="bg-white p-4 rounded-xl shadow-sm mb-4"><h3 class="font-bold mb-4">Ciclo</h3><div class="space-y-4 text-sm"><label class="block">Inicio: <input type="date" value="${user.config.lastPeriod}" onchange="updateConfig('lastPeriod', this.value)" class="border p-2 rounded w-full mt-1"/></label><div class="flex gap-4"><label class="flex-1">Ciclo: <input type="number" value="${user.config.cycleLen}" onchange="updateConfig('cycleLen', this.value)" class="border p-2 rounded w-full mt-1"/></label><label class="flex-1">Periodo: <input type="number" value="${user.config.periodLen}" onchange="updateConfig('periodLen', this.value)" class="border p-2 rounded w-full mt-1"/></label></div><label class="flex items-center gap-2 mt-2"><input type="checkbox" ${user.config.pill ? 'checked' : ''} onchange="updateConfig('pill', this.checked ? 'true' : 'false')"> Rastrear Pastilla</label><button onclick="alert('Guardado'); setView('calendar')" class="w-full py-2 bg-green-500 text-white rounded font-bold mt-2">Guardar Cambios</button></div></div>
                        <div class="bg-white p-4 rounded-xl shadow-sm text-center"><button onclick="openTutorial()" class="underline text-sm mb-4 block w-full">Ver Gu√≠a Educativa</button></div>
                    </div>
                `;
            }

            // MENU NAV
            const activeClass = "text-rose-500";
            const inactiveClass = "text-slate-400";
            html += `
                <div class="fixed bottom-0 w-full bg-white border-t border-slate-100 flex justify-around p-2 pb-4 z-40 no-print">
                    <button onclick="setView('calendar')" class="flex flex-col items-center p-2 ${state.view === 'calendar' ? activeClass : inactiveClass}">${ICONS.calendar} <span class="text-[10px] font-bold">Calendario</span></button>
                    <button onclick="setView('year')" class="flex flex-col items-center p-2 ${state.view === 'year' ? activeClass : inactiveClass}">${ICONS.grid} <span class="text-[10px] font-bold">A√±o</span></button>
                    <button onclick="setView('settings')" class="flex flex-col items-center p-2 ${state.view === 'settings' ? activeClass : inactiveClass}">${ICONS.settings} <span class="text-[10px] font-bold">Ajustes</span></button>
                </div>
            `;

            // MODAL
            if (state.selectedDate) {
                const k = state.selectedDate;
                const user = getUser();
                const log = user.logs[k] || {};
                const displayDate = new Date(k + 'T00:00:00').toLocaleDateString('es-ES', {weekday:'long', day:'numeric'});
                
                // S√≠ntomas HTML
                const symptomsHtml = ['happy','sad','irritable','cramps','bloating','tired'].map(s => {
                    const isActive = (log.symptoms || []).includes(s);
                    return `<button onclick="updateLog('symptoms', '${s}')" class="p-3 rounded-xl border flex flex-col items-center gap-1 ${isActive ? 'bg-rose-100 border-rose-200 text-rose-600' : 'border-slate-100 text-slate-400'}"><span class="capitalize text-xs font-bold">${s}</span></button>`;
                }).join('');

                html += `
                    <div class="fixed inset-0 z-50 bg-black/60 flex items-end justify-center animate-in" onclick="closeModal()">
                        <div class="w-full max-w-sm bg-white rounded-t-3xl p-6 h-[85vh] overflow-y-auto" onclick="event.stopPropagation()">
                            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold capitalize">${displayDate}</h3><button onclick="closeModal()" class="p-2 bg-gray-100 rounded-full">${ICONS.close}</button></div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="bg-blue-50 p-4 rounded-xl flex flex-col items-center"><div class="text-xs font-bold text-blue-500 mb-2 flex gap-1">${ICONS.droplet} AGUA</div><div class="flex items-center gap-3"><button onclick="updateLog('water', 'dec')" class="w-8 h-8 bg-white rounded-full font-bold shadow text-blue-500">-</button><span class="font-bold text-xl">${log.water||0}</span><button onclick="updateLog('water', 'inc')" class="w-8 h-8 bg-blue-500 text-white rounded-full font-bold shadow">+</button></div></div>
                                <div class="bg-indigo-50 p-4 rounded-xl flex flex-col items-center"><div class="text-xs font-bold text-indigo-500 mb-2 flex gap-1">${ICONS.moon} SUE√ëO</div><div class="flex items-center gap-3"><button onclick="updateLog('sleep', 'dec')" class="w-8 h-8 bg-white rounded-full font-bold shadow text-indigo-500">-</button><span class="font-bold text-xl">${log.sleep||0}h</span><button onclick="updateLog('sleep', 'inc')" class="w-8 h-8 bg-indigo-500 text-white rounded-full font-bold shadow">+</button></div></div>
                            </div>
                            <div class="mb-4"><label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Notas</label><textarea onchange="updateLog('notes', this.value)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl" rows="3">${log.notes||''}</textarea></div>
                            <div class="grid grid-cols-3 gap-2 mb-6">${symptomsHtml}</div>
                            <button onclick="closeModal()" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold shadow-lg">Guardar</button>
                        </div>
                    </div>
                `;
            }

            app.innerHTML = html;
        }

        render();
    </script>
</body>
</html>

