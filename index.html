<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunea - Tu Guía</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f8fafc; color: #1e293b; font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .day-cell:active { transform: scale(0.95); transition: 0.1s; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #f43f5e;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #f43f5e;
        }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
            #app { height: auto; overflow: visible; }
        }
    </style>
</head>
<body>

    <!-- CONTENEDOR PRINCIPAL -->
    <div id="app" class="min-h-screen pb-24 relative"></div>

    <!-- PANTALLA DE ERROR -->
    <div id="error-screen" class="hidden fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center p-8 text-center">
        <h2 class="text-red-500 font-bold text-xl mb-4">Error Crítico</h2>
        <button onclick="hardReset()" class="bg-red-500 text-white px-6 py-3 rounded-lg font-bold">Reiniciar de Fábrica</button>
    </div>

    <!-- LÓGICA NATIVA -->
    <script>
        // --- ICONOS ---
        const ICONS = {
            heart: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 fill-current" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>',
            calendar: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
            settings: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
            left: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>',
            right: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>',
            grid: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>',
            droplet: '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.74 5.88a6 6 0 0 1-8.48 8.48A6 6 0 0 1 5.25 9.56L12 2.69z"/></svg>',
            moon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
            users: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>',
            trash: '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
            edit: '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
            plus: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
            close: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
            check: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
            history: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>',
            pill: '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10"/><path d="M12 12 2 12"/></svg>'
        };

        // --- ESTADO ---
        const DB_KEY = 'lunea_v58_pill';
        let tutorialStep = 0; 

        let state = {
            view: 'calendar',
            currentMonth: new Date(),
            viewYear: new Date().getFullYear(),
            selectedDate: null,
            users: [{ id: '1', name: 'Yo', config: { lastPeriod: new Date().toISOString().split('T')[0], cycleLen: 28, periodLen: 5, pill: false }, periodHistory: [], logs: {} }],
            currentUserId: '1',
            showTutorial: true
        };

        // Cargar
        try {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed, currentMonth: new Date(), viewYear: new Date().getFullYear(), selectedDate: null };
                // Asegurar array de historial
                state.users.forEach(u => {
                    if (!u.periodHistory) u.periodHistory = [u.config.lastPeriod];
                });
            }
        } catch(e) { console.log('Error carga:', e); }

        // --- LÓGICA ---
        function save() { localStorage.setItem(DB_KEY, JSON.stringify(state)); render(); }
        function getUser() { return state.users.find(u => u.id === state.currentUserId) || state.users[0]; }
        
        function toKey(d) { const o = d.getTimezoneOffset() * 60000; return new Date(d.getTime() - o).toISOString().split('T')[0]; }

        function recalculateCycleStats(user) {
            if (!user.periodHistory || user.periodHistory.length < 2) return;

            const sortedHistory = [...user.periodHistory].sort((a, b) => new Date(a) - new Date(b));
            
            // Actualizar último periodo conocido
            const latest = sortedHistory[sortedHistory.length - 1];
            user.config.lastPeriod = latest;

            let totalDays = 0;
            let count = 0;

            for (let i = 1; i < sortedHistory.length; i++) {
                const prev = new Date(sortedHistory[i-1]);
                const curr = new Date(sortedHistory[i]);
                const diffTime = Math.abs(curr - prev);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // Permitir ciclos entre 15 y 50 días para el promedio
                if (diffDays >= 15 && diffDays <= 50) {
                    totalDays += diffDays;
                    count++;
                }
            }

            if (count > 0) {
                user.config.cycleLen = Math.round(totalDays / count);
            }
        }

        function togglePeriodStart(dateStr) {
            const user = getUser();
            if (!user.periodHistory) user.periodHistory = [];

            if (user.periodHistory.includes(dateStr)) {
                user.periodHistory = user.periodHistory.filter(d => d !== dateStr);
            } else {
                user.periodHistory.push(dateStr);
            }
            recalculateCycleStats(user);
            save();
        }

        // Nueva función para ir a hoy
        window.goToToday = () => {
            state.currentMonth = new Date();
            state.viewYear = new Date().getFullYear();
            render();
        };

        window.deleteHistoryItem = (dateStr) => {
            if(confirm('¿Borrar este inicio de periodo del historial?')) {
                const user = getUser();
                user.periodHistory = user.periodHistory.filter(d => d !== dateStr);
                recalculateCycleStats(user);
                save();
            }
        };

        function getCycleDay(dateStr) {
            const user = getUser();
            const start = new Date(user.config.lastPeriod + 'T00:00:00');
            const target = new Date(dateStr + 'T00:00:00');
            
            // Búsqueda histórica retrospectiva
            if (target < start && user.periodHistory && user.periodHistory.length > 0) {
                const sorted = [...user.periodHistory].sort((a, b) => new Date(b) - new Date(a));
                const relevantStart = sorted.find(d => new Date(d + 'T00:00:00') <= target);
                
                if (relevantStart) {
                    const rStart = new Date(relevantStart + 'T00:00:00');
                    const diff = Math.floor((target - rStart) / 86400000);
                    return diff + 1;
                }
            }

            const diff = Math.floor((target - start) / 86400000);
            if (diff < 0) return null;
            return (diff % user.config.cycleLen) + 1;
        }

        function getPhase(dateStr) {
            const cd = getCycleDay(dateStr);
            const user = getUser();
            if (!cd) return null;
            const ov = user.config.cycleLen - 14;
            const isStart = user.periodHistory && user.periodHistory.includes(dateStr);

            if (cd <= user.config.periodLen) return {l:'Menstruación', bg:'bg-rose-500', t:'text-rose-600', light:'bg-rose-100', isStart};
            if (cd >= ov - 5 && cd < ov) return {l:'Fértil', bg:'bg-purple-400', t:'text-purple-600', light:'bg-purple-100', isStart};
            if (cd === ov) return {l:'Ovulación', bg:'bg-purple-600', t:'text-purple-700', light:'bg-purple-200', isStart};
            if (cd > ov) return {l:'Lútea', bg:'bg-amber-400', t:'text-amber-600', light:'bg-amber-100', isStart};
            return {l:'Folicular', bg:'bg-pink-300', t:'text-pink-600', light:'bg-pink-50', isStart};
        }

        // --- ACCIONES GLOBAL ---
        window.hardReset = () => { localStorage.clear(); location.reload(); };
        window.setView = (v) => { state.view = v; render(); };
        window.closeModal = () => { state.selectedDate = null; render(); };
        window.setMonth = (delta) => { state.currentMonth.setMonth(state.currentMonth.getMonth() + delta); render(); };
        window.setYear = (delta) => { state.viewYear += delta; render(); };
        window.selectDate = (k) => { state.selectedDate = k; render(); };
        
        window.updateLog = (key, field, val) => {
            const user = getUser();
            if (!user.logs[key]) user.logs[key] = {};
            if (field === 'water' || field === 'sleep') {
                let current = user.logs[key][field] || 0;
                if (val === 'inc') current++; else if (val === 'dec') current = Math.max(0, current - 1);
                user.logs[key][field] = current;
            } else if (field === 'pill') { 
                user.logs[key].pill = !user.logs[key].pill; 
            }
            else if (field === 'symptoms') {
                let current = user.logs[key].symptoms || [];
                if(current.includes(val)) current = current.filter(s => s !== val); else current.push(val);
                user.logs[key].symptoms = current;
            }
            else { user.logs[key][field] = val; }
            save();
        };

        window.updateConfig = (field, val) => {
            const user = getUser();
            if(field !== 'lastPeriod' && field !== 'pill') val = parseInt(val);
            if(field === 'pill') val = val === 'true'; 
            user.config[field] = val;
            
            if (field === 'lastPeriod') {
                if (!user.periodHistory.includes(val)) {
                    user.periodHistory.push(val);
                    recalculateCycleStats(user);
                }
            }
            save();
        };
        
        window.handlePeriodToggle = (dateStr) => {
            togglePeriodStart(dateStr);
            render(); 
        };

        window.addUser = () => { const n = prompt("Nombre:"); if (n) { const id = Date.now().toString(); state.users.push({ id, name: n, config: {...getUser().config}, periodHistory: [], logs: {} }); state.currentUserId = id; save(); } };
        window.switchUser = (id) => { state.currentUserId = id; save(); };
        window.deleteUser = (id) => { if(state.users.length <= 1) return alert("Mínimo un usuario"); if(confirm("¿Borrar?")) { state.users = state.users.filter(u => u.id !== id); state.currentUserId = state.users[0].id; save(); } };
        window.editUser = (id) => { const u = state.users.find(u => u.id === id); const n = prompt("Nuevo nombre:", u.name); if (n) { u.name = n; save(); } };
        
        // TUTORIAL LOGIC
        window.nextSlide = () => { tutorialStep++; render(); };
        window.endTutorial = () => { state.showTutorial = false; tutorialStep = 0; save(); };
        window.openTutorial = () => { state.showTutorial = true; tutorialStep = 0; render(); };

        // --- RENDERIZADO ---
        function render() {
            const app = document.getElementById('app');
            let html = '';

            // TUTORIAL
            if (state.showTutorial) {
                const slides = [
                    { t: "Bienvenida a Lunea", d: "Tu espacio privado para conocer tu ciclo. Sin internet, 100% seguro en tu dispositivo.", i: ICONS.heart, c: "text-rose-500 bg-rose-100" },
                    { t: "Historial Inteligente", d: "Marca tus inicios de periodo. Lunea calculará tu promedio real automáticamente.", i: ICONS.history, c: "text-indigo-500 bg-indigo-100" },
                    { t: "Los Colores", d: `
                        <ul class="text-left text-sm space-y-2 bg-slate-50 p-4 rounded-xl">
                            <li class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-rose-500"></div> <b>Rojo:</b> Menstruación</li>
                            <li class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-purple-400"></div> <b>Morado:</b> Fértil</li>
                            <li class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-amber-400"></div> <b>Ámbar:</b> Lútea</li>
                        </ul>
                    `, i: ICONS.droplet, c: "text-teal-500 bg-teal-100" },
                    { t: "¡Empezar!", d: "Todo listo para comenzar.", i: ICONS.check, c: "text-green-500 bg-green-100" }
                ];
                
                const slide = slides[tutorialStep];
                
                app.innerHTML = `
                    <div class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-8 text-center fade-in">
                        <div class="p-6 rounded-full mb-6 ${slide.c.split(' ')[1]} ${slide.c.split(' ')[0]}">${slide.i}</div>
                        <h2 class="text-2xl font-bold mb-4 text-slate-800">${slide.t}</h2>
                        <div class="text-slate-500 mb-8 w-full max-w-xs">${slide.d}</div>
                        <button onclick="${tutorialStep < slides.length - 1 ? 'nextSlide()' : 'endTutorial()'}" class="w-full max-w-xs py-3 bg-slate-900 text-white rounded-xl font-bold shadow-lg">
                            ${tutorialStep < slides.length - 1 ? 'Siguiente' : 'Empezar'}
                        </button>
                    </div>
                `;
                return;
            }

            // PDF
            if (state.view === 'pdf') {
                const user = getUser();
                const logs = Object.keys(user.logs).sort().reverse().slice(0, 30);
                const rows = logs.map(k => {
                    const log = user.logs[k];
                    const pillText = user.config.pill ? (log.pill ? 'SÍ' : 'NO') : '-';
                    return `<tr class="border-b"><td class="py-2">${k}</td><td>${getCycleDay(k)}</td><td>${getPhase(k)?.l}</td><td>${pillText}</td><td>${(log.symptoms||[]).length}</td><td class="italic text-gray-500">${log.notes||'-'}</td></tr>`;
                }).join('');

                app.innerHTML = `
                    <div class="bg-white text-black p-8 min-h-screen">
                        <h1 class="text-2xl font-bold text-rose-600 mb-4">Reporte Médico</h1>
                        <p class="mb-4">Paciente: ${user.name} | Ciclo Promedio: ${user.config.cycleLen} días</p>
                        <table class="w-full text-sm text-left border-collapse">
                            <thead><tr class="border-b bg-gray-50"><th class="p-2">Fecha</th><th>Día</th><th>Fase</th><th>Pastilla</th><th>Sínt.</th><th>Notas</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                        <div class="mt-8 no-print text-center"><button onclick="window.print()" class="bg-black text-white px-6 py-2 rounded font-bold">Imprimir</button><button onclick="setView('report')" class="ml-4 underline">Volver</button></div>
                    </div>
                `;
                return;
            }

            // HEADER APP
            html += `<div class="px-6 py-4 flex justify-between items-center bg-white shadow-sm sticky top-0 z-20">
                <div class="flex items-center gap-2 text-rose-500">${ICONS.heart} <h1 class="text-xl font-bold text-slate-800">Lunea</h1></div>
                <button onclick="setView('settings')" class="text-slate-400 p-2">${ICONS.settings}</button>
            </div>`;

            // CALENDARIO MES
            if (state.view === 'calendar') {
                const user = getUser();
                const year = state.currentMonth.getFullYear();
                const month = state.currentMonth.getMonth();
                const startDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const todayK = toKey(new Date());
                const todayCD = getCycleDay(todayK);
                const todayP = getPhase(todayK);

                // Verificar si estamos en el mes actual para mostrar el botón HOY o no
                const isCurrentMonth = todayK.startsWith(`${year}-${String(month+1).padStart(2,'0')}`);

                let daysHtml = '';
                for(let i=0; i<startDay; i++) daysHtml += `<div></div>`;
                for(let i=1; i<=daysInMonth; i++) {
                    const d = new Date(year, month, i);
                    const k = toKey(d);
                    const cd = getCycleDay(k);
                    const p = getPhase(k);
                    const isToday = k === todayK;
                    const log = user.logs[k] || {};
                    const isPeriodStart = user.periodHistory && user.periodHistory.includes(k);
                    
                    let dots = '';
                    if(p) dots += `<div class="w-1.5 h-1.5 rounded-full ${p.bg}"></div>`;
                    if(log.pill) dots += `<div class="w-1.5 h-1.5 rounded-full bg-teal-400"></div>`; // Punto pastilla
                    if(log.water || log.sleep) dots += `<div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div>`;
                    if(log.symptoms && log.symptoms.length > 0) dots += `<div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>`;
                    if(isPeriodStart) dots = `<div class="w-2 h-2 rounded-full bg-red-600 border border-white ring-1 ring-red-200"></div>` + dots;

                    daysHtml += `
                        <button onclick="selectDate('${k}')" class="h-16 rounded-xl flex flex-col items-center justify-center relative day-cell border ${isToday ? 'border-rose-500 border-2' : (isPeriodStart ? 'border-rose-300 bg-rose-50' : 'border-slate-100')} ${p ? p.light : 'bg-white'}">
                            ${cd ? `<span class="absolute top-1 right-1 text-[10px] font-bold text-slate-400 font-mono">${cd}</span>` : ''}
                            <span class="text-sm font-bold ${p ? p.t : 'text-slate-600'}">${i}</span>
                            <div class="flex gap-0.5 mt-1 items-center">${dots}</div>
                        </button>
                    `;
                }

                html += `
                    <div class="p-4 max-w-md mx-auto animate-in">
                        <div class="rounded-[2rem] p-6 mb-6 text-center bg-white shadow-sm border border-slate-100 relative overflow-hidden">
                             ${todayP && todayP.l === 'Menstruación' ? '<div class="absolute top-0 left-0 w-full h-1 bg-rose-500"></div>' : ''}
                            <h2 class="text-xs font-bold uppercase text-slate-400 mb-2">${new Date().toLocaleDateString('es-ES', {weekday:'long', day:'numeric'})}</h2>
                            <div class="text-5xl font-black text-slate-800 mb-1">${todayCD || '?'}</div>
                            <div class="text-sm text-slate-500 mb-4">Día del Ciclo (Promedio: ${user.config.cycleLen} días)</div>
                            ${todayCD ? `<div class="inline-block px-4 py-1 rounded-full text-sm font-bold ${todayP.light} ${todayP.t}">${todayP.l}</div>` : `<button onclick="setView('settings')" class="bg-rose-500 text-white px-4 py-2 rounded animate-pulse">Configurar</button>`}
                        </div>
                        <div class="p-4 bg-white rounded-3xl shadow-sm mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <button onclick="setMonth(-1)" class="p-2 text-slate-400">${ICONS.left}</button>
                                <div class="text-center">
                                    <div class="font-bold capitalize text-lg">${state.currentMonth.toLocaleDateString('es-ES', {month:'long', year:'numeric'})}</div>
                                    ${!isCurrentMonth ? `<button onclick="goToToday()" class="mt-1 text-[10px] text-white bg-rose-500 px-2 py-0.5 rounded-full font-bold shadow-sm hover:bg-rose-600 transition">Volver a Hoy</button>` : ''}
                                </div>
                                <button onclick="setMonth(1)" class="p-2 text-slate-400">${ICONS.right}</button>
                            </div>
                            <div class="grid grid-cols-7 text-center text-xs text-slate-400 font-bold mb-2"><span>D</span><span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span></div>
                            <div class="grid grid-cols-7 gap-1">${daysHtml}</div>
                        </div>
                    </div>
                `;
            }

            // VISTA ANUAL
            else if (state.view === 'year') {
                let monthsHtml = '';
                for(let m=0; m<12; m++) {
                    const currentY = state.viewYear;
                    const date = new Date(currentY, m, 1);
                    const daysInM = new Date(currentY, m+1, 0).getDate();
                    const startDay = date.getDay(); 
                    
                    let daysGrid = '';
                    for(let i=0; i<startDay; i++) daysGrid += `<div></div>`;
                    
                    for(let d=1; d<=daysInM; d++) {
                        const k = toKey(new Date(currentY, m, d));
                        const p = getPhase(k);
                        const isStart = getUser().periodHistory.includes(k);
                        
                        let bg = 'bg-slate-100 text-slate-300';
                        if (isStart) bg = 'bg-red-600 text-white font-bold';
                        else if (p && p.l === 'Menstruación') bg = 'bg-rose-400 text-white';
                        else if (p && p.l === 'Fértil') bg = 'bg-purple-300 text-purple-900';
                        else if (p && p.l === 'Ovulación') bg = 'bg-purple-600 text-white font-bold';
                        else if (p) bg = 'bg-slate-100 text-slate-900';

                        daysGrid += `<div class="w-full aspect-square rounded-sm text-[6px] flex items-center justify-center ${bg}">${d}</div>`;
                    }

                    monthsHtml += `
                        <div class="bg-white p-2 rounded-lg border border-slate-100">
                            <div class="font-bold text-xs text-center mb-1 capitalize text-slate-700">${date.toLocaleDateString('es-ES',{month:'long'})}</div>
                            <div class="grid grid-cols-7 gap-[1px] mb-1">
                                ${['D','L','M','M','J','V','S'].map(day => `<div class="text-[6px] text-center text-slate-400">${day}</div>`).join('')}
                            </div>
                            <div class="grid grid-cols-7 gap-[1px]">
                                ${daysGrid}
                            </div>
                        </div>`;
                }
                
                html += `
                    <div class="p-4 animate-in mb-24">
                        <div class="flex justify-between items-center mb-6 sticky top-0 bg-[#f8fafc] py-2 z-10">
                            <button onclick="setView('calendar')">${ICONS.left}</button>
                            <div class="flex gap-4 items-center">
                                <button onclick="setYear(-1)" class="p-2 bg-white rounded-full shadow-sm">${ICONS.left}</button>
                                <h2 class="text-xl font-bold text-slate-800">${state.viewYear}</h2>
                                <button onclick="setYear(1)" class="p-2 bg-white rounded-full shadow-sm">${ICONS.right}</button>
                            </div>
                            <div class="w-6"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4">${monthsHtml}</div>
                    </div>
                `;
            }

            // AJUSTES
            else if (state.view === 'settings') {
                const user = getUser();
                let usersHtml = state.users.map(u => `
                    <div class="flex justify-between items-center py-3 border-b last:border-0">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold">${u.name[0]}</div>
                            <div class="flex flex-col">
                                <button onclick="switchUser('${u.id}')" class="text-left font-bold ${u.id===state.currentUserId?'text-rose-600':'text-slate-700'}">${u.name}</button>
                                <span class="text-[10px] text-slate-400">ID: ${u.id.substr(0,4)}</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editUser('${u.id}')" class="p-2 text-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 transition">${ICONS.edit}</button>
                            ${state.users.length>1 ? `<button onclick="deleteUser('${u.id}')" class="p-2 text-red-500 bg-red-50 rounded-lg hover:bg-red-100 transition">${ICONS.trash}</button>` : ''}
                        </div>
                    </div>
                `).join('');
                
                let historyHtml = '<div class="text-center py-4 text-slate-400 italic text-sm">No hay registros aún.</div>';
                if(user.periodHistory && user.periodHistory.length > 0) {
                     historyHtml = user.periodHistory
                        .sort((a,b) => new Date(b) - new Date(a))
                        .map(d => `
                            <div class="flex justify-between items-center text-sm py-2 border-b border-slate-50 last:border-0">
                                <span class="font-mono text-slate-600">${d}</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-bold text-rose-500 bg-rose-50 px-2 py-1 rounded-full">Inicio</span>
                                    <button onclick="deleteHistoryItem('${d}')" class="text-slate-400 hover:text-red-500 p-1">${ICONS.trash}</button>
                                </div>
                            </div>`)
                        .join('');
                }

                html += `
                    <div class="p-6 max-w-md mx-auto animate-in">
                        <div class="flex justify-between mb-6"><button onclick="setView('calendar')">${ICONS.left}</button><h2 class="text-xl font-bold">Ajustes</h2><div></div></div>
                        
                        <div class="bg-white p-5 rounded-2xl shadow-sm mb-6">
                             <h3 class="font-bold mb-4 flex gap-2 items-center text-rose-500 text-lg">${ICONS.history} Historial</h3>
                             <div class="bg-indigo-50 p-4 rounded-xl mb-4">
                                <div class="text-xs text-indigo-400 font-bold uppercase mb-1">Promedio Calculado</div>
                                <div class="text-2xl font-black text-indigo-900">${user.config.cycleLen} días</div>
                                <div class="text-[10px] text-indigo-400 mt-1">Basado en tus últimos registros válidos</div>
                             </div>
                             <div class="max-h-64 overflow-y-auto pr-2 custom-scroll">${historyHtml}</div>
                        </div>

                        <div class="bg-white p-5 rounded-2xl shadow-sm mb-6">
                            <div class="flex justify-between mb-4 items-center">
                                <h3 class="font-bold text-lg text-slate-800">Usuarios</h3>
                                <button onclick="addUser()" class="text-white bg-rose-500 p-1 rounded-lg">${ICONS.plus}</button>
                            </div>
                            <div class="flex flex-col">${usersHtml}</div>
                        </div>
                        
                        <div class="bg-white p-5 rounded-2xl shadow-sm mb-6">
                            <h3 class="font-bold mb-4 text-slate-800 text-lg">Configuración Manual</h3>
                            <div class="space-y-4 text-sm">
                                <label class="block">
                                    <span class="text-slate-500 text-xs font-bold uppercase">Último Periodo</span>
                                    <input type="date" value="${user.config.lastPeriod}" onchange="updateConfig('lastPeriod', this.value)" class="border border-slate-200 p-3 rounded-xl w-full mt-1 bg-slate-50"/>
                                </label>
                                <div class="flex gap-4">
                                    <label class="flex-1">
                                        <span class="text-slate-500 text-xs font-bold uppercase">Ciclo (Días)</span>
                                        <input type="number" value="${user.config.cycleLen}" onchange="updateConfig('cycleLen', this.value)" class="border border-slate-200 p-3 rounded-xl w-full mt-1 bg-slate-50"/>
                                    </label>
                                    <label class="flex-1">
                                        <span class="text-slate-500 text-xs font-bold uppercase">Sangrado (Días)</span>
                                        <input type="number" value="${user.config.periodLen}" onchange="updateConfig('periodLen', this.value)" class="border border-slate-200 p-3 rounded-xl w-full mt-1 bg-slate-50"/>
                                    </label>
                                </div>
                                <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-teal-50 hover:border-teal-200 transition">
                                    <input type="checkbox" ${user.config.pill ? 'checked' : ''} onchange="updateConfig('pill', this.checked ? 'true' : 'false')" class="w-5 h-5 accent-teal-500"> 
                                    <div class="flex flex-col">
                                        <span class="font-bold text-slate-700">Modo Pastilla Anticonceptiva</span>
                                        <span class="text-xs text-slate-400">Activa el registro diario de toma</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="text-center opacity-50 mb-12">
                            <button onclick="openTutorial()" class="underline text-sm">Ver Tutorial de Nuevo</button>
                            <div class="text-[10px] mt-2">v5.8.0 Local Storage</div>
                        </div>
                    </div>
                `;
            }

            // MENU NAV
            const activeClass = "text-rose-500 scale-110 transition-transform";
            const inactiveClass = "text-slate-300";
            html += `
                <div class="fixed bottom-0 w-full bg-white border-t border-slate-100 flex justify-around p-2 pb-6 z-40 no-print shadow-[0_-5px_20px_rgba(0,0,0,0.02)]">
                    <button onclick="setView('calendar')" class="flex flex-col items-center p-2 ${state.view === 'calendar' ? activeClass : inactiveClass}">${ICONS.calendar} <span class="text-[10px] font-bold mt-1">Hoy</span></button>
                    <button onclick="setView('year')" class="flex flex-col items-center p-2 ${state.view === 'year' ? activeClass : inactiveClass}">${ICONS.grid} <span class="text-[10px] font-bold mt-1">Año</span></button>
                    <button onclick="setView('settings')" class="flex flex-col items-center p-2 ${state.view === 'settings' ? activeClass : inactiveClass}">${ICONS.settings} <span class="text-[10px] font-bold mt-1">Perfil</span></button>
                </div>
            `;

            // MODAL
            if (state.selectedDate) {
                const k = state.selectedDate;
                const user = getUser();
                const log = user.logs[k] || {};
                const displayDate = new Date(k + 'T00:00:00').toLocaleDateString('es-ES', {weekday:'long', day:'numeric'});
                const isPeriodStart = user.periodHistory && user.periodHistory.includes(k);
                
                // Síntomas HTML
                const symptomsHtml = ['happy','sad','irritable','cramps','bloating','tired'].map(s => {
                    const isActive = (log.symptoms || []).includes(s);
                    return `<button onclick="updateLog('symptoms', '${s}')" class="p-3 rounded-xl border flex flex-col items-center gap-1 ${isActive ? 'bg-rose-100 border-rose-200 text-rose-600' : 'border-slate-100 text-slate-400'}"><span class="capitalize text-xs font-bold">${s}</span></button>`;
                }).join('');

                // Sección Pastilla (Condicional)
                let pillSection = '';
                if (user.config.pill) {
                    const taken = log.pill;
                    pillSection = `
                        <div class="bg-teal-50 p-4 rounded-xl mb-4 flex justify-between items-center border border-teal-100 animate-in">
                            <div class="flex items-center gap-3">
                                <div class="bg-white p-2 rounded-full text-teal-500 shadow-sm">${ICONS.pill}</div>
                                <div>
                                    <h4 class="font-bold text-slate-800">Anticonceptivo</h4>
                                    <p class="text-xs text-teal-600">${taken ? 'Tomada hoy' : 'Pendiente'}</p>
                                </div>
                            </div>
                            <button onclick="updateLog('pill')" class="px-4 py-2 rounded-lg font-bold text-sm transition ${taken ? 'bg-teal-500 text-white shadow-lg shadow-teal-200' : 'bg-white text-teal-500 border border-teal-200'}">
                                ${taken ? 'Tomada' : 'Marcar'}
                            </button>
                        </div>
                    `;
                }

                html += `
                    <div class="fixed inset-0 z-50 bg-black/60 flex items-end justify-center animate-in" onclick="closeModal()">
                        <div class="w-full max-w-sm bg-white rounded-t-[2rem] p-6 h-[85vh] overflow-y-auto shadow-2xl" onclick="event.stopPropagation()">
                            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold capitalize text-slate-800">${displayDate}</h3><button onclick="closeModal()" class="p-2 bg-slate-100 rounded-full hover:bg-slate-200 text-slate-500">${ICONS.close}</button></div>
                            
                            <!-- SECCIÓN INICIO DE PERIODO -->
                            <div class="bg-rose-50 p-5 rounded-2xl mb-4 border border-rose-100 relative overflow-hidden">
                                ${isPeriodStart ? '<div class="absolute -right-4 -top-4 w-16 h-16 bg-rose-200 rounded-full opacity-50"></div>' : ''}
                                <div class="flex justify-between items-center relative z-10">
                                    <div class="flex items-center gap-4">
                                        <div class="bg-white p-3 rounded-full text-rose-500 shadow-sm">${ICONS.droplet}</div>
                                        <div>
                                            <h4 class="font-bold text-slate-800">Menstruación</h4>
                                            <p class="text-xs text-slate-500">¿Inició hoy?</p>
                                        </div>
                                    </div>
                                    <div class="relative inline-block w-14 h-8 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="toggle" id="periodToggle" class="toggle-checkbox absolute block w-8 h-8 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300" ${isPeriodStart ? 'checked' : ''} onclick="handlePeriodToggle('${k}')"/>
                                        <label for="periodToggle" class="toggle-label block overflow-hidden h-8 rounded-full bg-slate-300 cursor-pointer transition-all duration-300"></label>
                                    </div>
                                </div>
                                ${isPeriodStart ? '<p class="text-xs text-rose-600 mt-3 font-bold text-center bg-white/50 py-1 rounded-lg">✅ Inicio registrado</p>' : ''}
                            </div>

                            <!-- SECCIÓN PASTILLA -->
                            ${pillSection}

                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="bg-blue-50 p-4 rounded-2xl flex flex-col items-center"><div class="text-xs font-bold text-blue-400 mb-2 flex gap-1 uppercase tracking-wider">${ICONS.droplet} Agua</div><div class="flex items-center gap-3"><button onclick="updateLog('water', 'dec')" class="w-8 h-8 bg-white rounded-full font-bold shadow-sm text-blue-500 hover:scale-105 transition">-</button><span class="font-black text-xl text-slate-700">${log.water||0}</span><button onclick="updateLog('water', 'inc')" class="w-8 h-8 bg-blue-500 text-white rounded-full font-bold shadow-lg shadow-blue-200 hover:scale-105 transition">+</button></div></div>
                                <div class="bg-indigo-50 p-4 rounded-2xl flex flex-col items-center"><div class="text-xs font-bold text-indigo-400 mb-2 flex gap-1 uppercase tracking-wider">${ICONS.moon} Sueño</div><div class="flex items-center gap-3"><button onclick="updateLog('sleep', 'dec')" class="w-8 h-8 bg-white rounded-full font-bold shadow-sm text-indigo-500 hover:scale-105 transition">-</button><span class="font-black text-xl text-slate-700">${log.sleep||0}h</span><button onclick="updateLog('sleep', 'inc')" class="w-8 h-8 bg-indigo-500 text-white rounded-full font-bold shadow-lg shadow-indigo-200 hover:scale-105 transition">+</button></div></div>
                            </div>
                            <div class="mb-6"><label class="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-wider">Notas del día</label><textarea onchange="updateLog('notes', this.value)" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:outline-none focus:border-rose-300 focus:ring-2 focus:ring-rose-100 transition" rows="3" placeholder="¿Cómo te sentiste hoy?">${log.notes||''}</textarea></div>
                            <div class="grid grid-cols-3 gap-3 mb-8">${symptomsHtml}</div>
                            <button onclick="closeModal()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-xl active:scale-95 transition">Guardar Cambios</button>
                        </div>
                    </div>
                `;
            }

            app.innerHTML = html;
        }

        render();
    </script>
</body>
</html>
