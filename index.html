<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunea - Completa</title>
    
    <!-- Librer√≠as (React 17 - Estabilidad) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f8fafc; color: #1e293b; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .day-cell:active { transform: scale(0.95); }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 0; }
        @media print { .no-print { display: none !important; } body { background: white; } #root { height: auto; overflow: visible; } }
    </style>
</head>
<body>

    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
            <p style="color: #64748b; margin-bottom: 20px;">Cargando Lunea v50...</p>
            <button onclick="localStorage.removeItem('lunea_v50_db'); location.reload()" style="padding: 10px 20px; background: #ef4444; color: white; border:none; border-radius: 8px;">Restablecer Todo</button>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONOS SEGUROS ---
        const Svg = ({d, c, click}) => <svg onClick={click} className={c} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{d}</svg>;

        // CORRECCI√ìN: Todos los iconos con m√∫ltiples elementos est√°n envueltos en <>...</>
        const Icons = {
            Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />,
            Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></>,
            Settings: <><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></>,
            Left: <polyline points="15 18 9 12 15 6" />,
            Right: <polyline points="9 18 15 12 9 6" />,
            Grid: <><rect x="3" y="3" width="7" height="7" /><rect x="14" y="3" width="7" height="7" /><rect x="14" y="14" width="7" height="7" /><rect x="3" y="14" width="7" height="7" /></>,
            Activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />,
            Droplet: <path d="M12 2.69l5.74 5.88a6 6 0 0 1-8.48 8.48A6 6 0 0 1 5.25 9.56L12 2.69z" />,
            Moon: <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />,
            Pill: <rect x="2" y="6" width="20" height="12" rx="6" />,
            Check: <polyline points="20 6 9 17 4 12" />,
            Users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /></>,
            Trash: <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></>,
            Plus: <><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></>,
            Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></>,
            Upload: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></>,
            Eye: <><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" /><circle cx="12" cy="12" r="3" /></>,
            EyeOff: <><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" /><line x1="1" y1="1" x2="23" y2="23" /></>,
            FileText: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></>,
            Sparkles: <><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M19 21v-4"/><path d="M15 19h4"/></>,
            Thermo: <path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z" />,
            Scale: <><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" /><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" /><path d="M7 21h10" /><path d="M12 3v18" /><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2" /></>,
            Close: <><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></>,
            Smile: <><circle cx="12" cy="12" r="10" /><path d="M8 14s1.5 2 4 2 4-2 4-2" /></>,
            Frown: <><circle cx="12" cy="12" r="10" /><path d="M16 16s-1.5-2-4-2-4 2-4 2" /><line x1="9" y1="9" x2="9.01" y2="9" /><line x1="15" y1="9" x2="15.01" y2="9" /></>,
            Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
            Cloud: <><line x1="16" y1="13" x2="16" y2="21" /><line x1="8" y1="13" x2="8" y2="21" /><line x1="12" y1="15" x2="12" y2="23" /><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25" /></>,
            Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></>,
            Sun: <><circle cx="12" cy="12" r="5" /><line x1="12" y1="1" x2="12" y2="3" /><line x1="12" y1="21" x2="12" y2="23" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /><line x1="1" y1="12" x2="3" y2="12" /><line x1="21" y1="12" x2="23" y2="12" /><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" /></>
        };

        const SYMPTOMS = [
            { id: 'happy', label: 'Feliz', I: Icons.Smile },
            { id: 'sad', label: 'Triste', I: Icons.Frown },
            { id: 'irritable', label: 'Irritable', I: Icons.Zap },
            { id: 'cramps', label: 'C√≥licos', I: Icons.Activity },
            { id: 'headache', label: 'Dolor', I: Icons.Thermo },
            { id: 'bloating', label: 'Hinchaz√≥n', I: Icons.Droplet },
            { id: 'energetic', label: 'Energ√≠a', I: Icons.Sun },
            { id: 'tired', label: 'Cansada', I: Icons.Cloud }
        ];

        const THEMES = {
            rose: { bg: 'bg-rose-500', text: 'text-rose-600', light: 'bg-rose-100', border: 'border-rose-200' },
            teal: { bg: 'bg-teal-500', text: 'text-teal-600', light: 'bg-teal-100', border: 'border-teal-200' },
            indigo: { bg: 'bg-indigo-500', text: 'text-indigo-600', light: 'bg-indigo-100', border: 'border-indigo-200' },
        };

        const SimpleChart = ({ data, color, minVal, maxVal }) => {
            if (!data || data.length < 2) return <div className="h-32 flex items-center justify-center text-xs border border-dashed rounded-xl text-slate-400">Registra al menos 2 datos</div>;
            const points = data.map((d, i) => {
                const val = parseFloat(d.val);
                if(isNaN(val)) return null;
                const norm = Math.max(0, Math.min(100, ((val - minVal) / (maxVal - minVal)) * 100));
                const y = 100 - norm;
                const x = (i / (data.length - 1)) * 100;
                return `${x},${y}`;
            }).filter(p=>p).join(' ');

            return (
                <div className="w-full h-32 relative mt-4">
                    <svg className="w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <polyline fill="none" stroke={color} strokeWidth="2" points={points} />
                    </svg>
                </div>
            );
        };

        const TutorialModal = ({ onComplete }) => {
            const steps = [
                {t:"Bienvenida a Lunea", d:"Tu ciclo, tu privacidad. Todo se guarda aqu√≠.", I:Icons.Heart},
                {t:"Calendario", d:"Registra tu ciclo. El n√∫mero grande es la fecha, el peque√±o es el d√≠a del ciclo.", I:Icons.Calendar},
                {t:"Salud e IA", d:"Registra s√≠ntomas y recibe an√°lisis inteligentes.", I:Icons.Sparkles},
                {t:"Planificador", d:"Usa la vista anual para ver meses futuros.", I:Icons.Grid}
            ];
            const [step, setStep] = useState(0);
            const StepIcon = steps[step].I;
            return (
                <div className="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 text-center animate-in">
                    <div className="bg-rose-100 p-6 rounded-full text-rose-500 mb-6"><Svg d={StepIcon} c="w-12 h-12"/></div>
                    <h2 className="text-2xl font-bold mb-4 text-slate-800">{steps[step].t}</h2>
                    <p className="text-slate-500 mb-8">{steps[step].d}</p>
                    <button onClick={() => step < steps.length - 1 ? setStep(step+1) : onComplete()} className="w-full py-3 bg-rose-500 text-white rounded-xl font-bold shadow-lg">
                        {step === steps.length - 1 ? "Comenzar" : "Siguiente"}
                    </button>
                </div>
            );
        };

        const PinPad = ({ onUnlock, onSetPin, isSetting, onCancel }) => {
            const [val, setVal] = useState('');
            const handle = (n) => {
                const next = val + n;
                setVal(next);
                if (next.length === 4) { if(isSetting) onSetPin(next); else onUnlock(next); setVal(''); }
            };
            return (
                <div className="fixed inset-0 bg-slate-900 z-[60] flex flex-col items-center justify-center text-white p-4">
                    <h2 className="text-xl font-bold mb-8">{isSetting?'Crear PIN':'Bloqueado'}</h2>
                    <div className="flex gap-4 mb-8">{[0,1,2,3].map(i=><div key={i} className={`w-4 h-4 rounded-full ${val.length>i?'bg-white':'bg-slate-700'}`}/>)}</div>
                    <div className="grid grid-cols-3 gap-6">
                        {[1,2,3,4,5,6,7,8,9].map(n=><button key={n} onClick={()=>handle(n.toString())} className="w-16 h-16 rounded-full bg-slate-800 text-xl font-bold">{n}</button>)}
                        <div/><button onClick={()=>handle('0')} className="w-16 h-16 rounded-full bg-slate-800 text-xl font-bold">0</button>
                        <button onClick={()=>isSetting?onCancel():setVal('')} className="w-16 h-16 rounded-full flex items-center justify-center"><Svg d={Icons.Left} c="w-8 h-8"/></button>
                    </div>
                </div>
            )
        };

        const App = () => {
            const [db, setDb] = useState(() => {
                try {
                    const saved = localStorage.getItem('lunea_v50_db');
                    if (saved) return JSON.parse(saved);
                } catch(e) {}
                const uid = Date.now().toString();
                // Fecha HOY en formato YYYY-MM-DD
                const today = new Date();
                const todayStr = new Date(today.getTime() - today.getTimezoneOffset() * 60000).toISOString().split('T')[0];
                return {
                    currentUserId: uid,
                    users: [{ id: uid, name: 'Yo', config: { lastPeriod: todayStr, cycleLen: 28, periodLen: 5, pill: false }, logs: {} }],
                    theme: 'rose', darkMode: false, pin: null, showTutorial: true
                };
            });

            const [view, setView] = useState('calendar');
            const [selDay, setSelDay] = useState(null);
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [viewYear, setViewYear] = useState(new Date().getFullYear());
            const [locked, setLocked] = useState(!!db.pin);
            const [showPinSetup, setShowPinSetup] = useState(false);
            const fileRef = useRef(null);

            useEffect(() => localStorage.setItem('lunea_v50_db', JSON.stringify(db)), [db]);

            const user = db.users.find(u => u.id === db.currentUserId) || db.users[0];
            const theme = THEMES[db.theme] || THEMES.rose;
            const dark = db.darkMode;

            useEffect(() => { document.body.className = dark ? 'bg-slate-950 text-slate-100' : 'bg-slate-50 text-slate-800'; }, [dark]);

            // L√≥gica
            const toKey = d => new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().split('T')[0];
            const getCycleDay = (dStr) => {
                if (!user.config.lastPeriod) return null;
                const start = new Date(user.config.lastPeriod); start.setHours(0,0,0,0);
                const target = new Date(dStr); target.setHours(0,0,0,0);
                const diffTime = target.getTime() - start.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                if(diffDays < 0) return null;
                return (diffDays % user.config.cycleLen) + 1;
            };
            const getPhase = (dStr) => {
                const cd = getCycleDay(dStr);
                if (!cd) return null;
                const ov = user.config.cycleLen - 14;
                if(cd <= user.config.periodLen) return {l:'Menstruaci√≥n', bg:'bg-rose-500', t:'text-rose-600', light:'bg-rose-100'};
                if(cd >= ov-5 && cd < ov) return {l:'F√©rtil', bg:'bg-purple-400', t:'text-purple-600', light:'bg-purple-100'};
                if(cd === ov) return {l:'Ovulaci√≥n', bg:'bg-purple-600', t:'text-purple-700', light:'bg-purple-200'};
                return {l:'Fase Segura', bg:'bg-slate-300', t:'text-slate-500', light:'bg-slate-100'};
            };

            const updateLog = (k, f, v) => {
                const newLogs = { ...user.logs };
                if (!newLogs[k]) newLogs[k] = {};
                newLogs[k][f] = v;
                setDb(p => ({...p, users: p.users.map(u => u.id === user.id ? {...u, logs: newLogs} : u)}));
            };
            const updateConfig = (f, v) => setDb(p => ({...p, users: p.users.map(u => u.id === user.id ? {...u, config: {...user.config, [f]: v}} : u)}));

            const handleExport = () => { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(db)); a.download="lunea.json"; a.click(); };
            const handleImport = (e) => { const r=new FileReader(); r.onload=ev=>{ try{ setDb(JSON.parse(ev.target.result)); alert("Importado"); }catch(er){alert("Error");} }; r.readAsText(e.target.files[0]); };
            const handleAddUser = () => { const n = prompt("Nombre:"); if(n) { const id = Date.now().toString(); setDb(p => ({...p, currentUserId: id, users: [...p.users, {id, name: n, config: user.config, logs: {}}]})); } };
            const handleEditUser = (id) => { const u = db.users.find(x => x.id === id); const n = prompt("Nuevo nombre:", u.name); if(n) setDb(p => ({...p, users: p.users.map(x => x.id === id ? {...x, name: n} : x)})); };
            const handleDeleteUser = (id) => { if(db.users.length>1 && confirm("¬øBorrar?")) setDb(p => ({...p, users: p.users.filter(x => x.id !== id), currentUserId: p.users[0].id})); };

            const getInsights = () => {
                const logs = Object.values(user.logs);
                const ins = [`üìÖ Ciclo promedio: ${user.config.cycleLen} d√≠as.`];
                if (logs.filter(l => l.water < 4).length > 2) ins.push("üíß Hidrataci√≥n baja detectada.");
                return ins;
            };

            if (db.showTutorial) return <TutorialModal onComplete={() => setDb({...db, showTutorial: false})} />;
            if (locked) return <PinPad onUnlock={c => c===db.pin?setLocked(false):alert("Mal")} isSetting={false} />;
            if (showPinSetup) return <PinPad isSetting={true} onSetPin={c => {setDb({...db, pin:c}); setShowPinSetup(false);}} onCancel={()=>setShowPinSetup(false)} />;

            if (view === 'pdf') {
                return (
                    <div className="bg-white text-black p-8 min-h-screen">
                        <div className="flex justify-between border-b pb-4 mb-6"><h1 className="text-2xl font-bold text-rose-600">Reporte M√©dico</h1><p>{new Date().toLocaleDateString()}</p></div>
                        <div className="mb-6 p-4 bg-gray-100 rounded flex gap-8">
                            <div><p className="text-xs text-gray-500 uppercase">Ciclo</p><p className="font-bold text-xl">{user.config.cycleLen} d√≠as</p></div>
                            <div><p className="text-xs text-gray-500 uppercase">Periodo</p><p className="font-bold text-xl">{user.config.periodLen} d√≠as</p></div>
                        </div>
                        <table className="w-full text-sm text-left border-collapse">
                            <thead><tr className="border-b bg-gray-50"><th className="py-2 px-2">Fecha</th><th>D√≠a</th><th>Fase</th><th>S√≠ntomas</th><th>Notas</th><th>Temp</th></tr></thead>
                            <tbody>{Object.keys(user.logs).sort().reverse().slice(0,30).map(k=>(
                                <tr key={k} className="border-b">
                                    <td className="py-2 px-2">{k}</td><td>{getCycleDay(k)}</td><td>{getPhase(k)?.l}</td>
                                    <td>{(user.logs[k].symptoms||[]).map(s=>SYMPTOMS.find(x=>x.id===s)?.label).join(', ')}</td><td className="italic text-gray-500">{user.logs[k].notes}</td><td>{user.logs[k].temp}</td>
                                </tr>
                            ))}</tbody>
                        </table>
                        <div className="mt-8 no-print text-center"><button onClick={()=>window.print()} className="bg-black text-white px-6 py-2 rounded font-bold">Imprimir</button><button onClick={()=>setView('report')} className="ml-6 underline">Volver</button></div>
                    </div>
                );
            }

            const renderYear = () => (
                <div className="p-4 animate-in">
                    <div className="flex justify-between items-center mb-6">
                        <button onClick={()=>setView('calendar')}><Svg d={Icons.Left} c="w-6 h-6"/></button>
                        <div className="flex items-center gap-4"><button onClick={()=>setViewYear(y=>y-1)}><Svg d={Icons.Left} c="w-4 h-4"/></button><h2 className="text-xl font-bold">A√±o {viewYear}</h2><button onClick={()=>setViewYear(y=>y+1)}><Svg d={Icons.Right} c="w-4 h-4"/></button></div><div className="w-6"/>
                    </div>
                    <div className="grid grid-cols-3 gap-2">
                        {Array.from({length:12}).map((_,m) => (
                            <div key={m} className={`p-1 rounded border text-[7px] ${dark?'bg-slate-900 border-slate-700':'bg-white'}`}>
                                <div className="font-bold text-center mb-1">{new Date(viewYear, m).toLocaleDateString('es-ES',{month:'short'})}</div>
                                <div className="grid grid-cols-7 gap-[1px]">
                                    {Array.from({length: new Date(viewYear, m+1, 0).getDate()}).map((_, d) => {
                                        const p = getPhase(toKey(new Date(viewYear, m, d+1)));
                                        return <div key={d} className={`aspect-square rounded-[1px] ${p ? p.bg : 'bg-slate-100 opacity-20'}`}></div>
                                    })}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            const renderCalendar = () => {
                const startDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay();
                const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 0).getDate();
                const days = [];
                for(let i=0; i<startDay; i++) days.push(<div key={`e-${i}`}/>);
                for(let i=1; i<=daysInMonth; i++) {
                    const d = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), i);
                    const k = toKey(d);
                    const cd = getCycleDay(k);
                    const p = getPhase(k);
                    const isToday = k === toKey(new Date());
                    const log = user.logs[k] || {};
                    days.push(
                        <button key={k} onClick={() => setSelDay({d, k})} className={`day-cell h-14 rounded-xl flex flex-col items-center justify-center border border-transparent ${p ? p.light : ''} ${isToday ? 'ring-2 ring-rose-500 z-10' : ''}`}>
                            <span className={`text-sm font-bold ${p ? p.text : (dark?'text-slate-400':'text-slate-600')}`}>{i}</span>
                            {cd && <span className={`absolute top-1 right-1 text-[9px] ${dark?'text-slate-500':'text-slate-400'}`}>{cd}</span>}
                            <div className="flex gap-0.5 mt-1">
                                {p && <div className={`w-1.5 h-1.5 rounded-full ${p.bg}`}></div>}
                                {(log.water || log.sleep) && <div className="w-1.5 h-1.5 rounded-full bg-blue-400"></div>}
                                {log.notes && <div className="w-1.5 h-1.5 rounded-full bg-yellow-400"></div>}
                            </div>
                        </button>
                    );
                }
                return (
                    <div className={`p-4 rounded-3xl mb-6 ${dark?'bg-slate-900':'bg-white shadow-sm'}`}>
                        <div className="flex justify-between items-center mb-4">
                            <button onClick={()=>setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()-1)))} className="p-2"><Svg d={Icons.Left} c="w-5 h-5"/></button>
                            <div className="flex items-center gap-2"><span className="font-bold capitalize">{currentMonth.toLocaleDateString('es-ES', {month:'long', year:'numeric'})}</span><button onClick={()=>setCurrentMonth(new Date())} className="text-[10px] px-2 py-1 rounded font-bold bg-rose-100 text-rose-600">HOY</button></div>
                            <button onClick={()=>setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()+1)))} className="p-2"><Svg d={Icons.Right} c="w-5 h-5"/></button>
                        </div>
                        <div className="grid grid-cols-7 text-center text-xs text-slate-400 font-bold mb-2"><span>D</span><span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span></div>
                        <div className="grid grid-cols-7 gap-1">{days}</div>
                    </div>
                );
            };

            // PRINCIPAL
            return (
                <div className={`min-h-screen pb-20 ${dark ? 'text-white' : 'text-slate-800'}`}>
                    {view !== 'pdf' && view !== 'year' && (
                        <header className="px-6 py-4 flex justify-between items-center">
                            <div className={`flex items-center gap-2 ${theme.text}`}><Svg d={Icons.Heart} c="w-6 h-6 fill-current"/><h1 className="text-xl font-bold">Lunea</h1></div>
                            <button onClick={()=>setView('settings')}><Svg d={Icons.Settings} c="w-6 h-6 text-slate-400"/></button>
                        </header>
                    )}

                    {view === 'calendar' ? (
                        <div className="max-w-md mx-auto p-4">
                            <div className={`rounded-[2rem] p-6 mb-6 text-center shadow-sm border ${dark?'bg-slate-900 border-slate-800':'bg-white border-slate-100'}`}>
                                <h2 className="text-xs font-bold uppercase text-slate-400 mb-2">{new Date().toLocaleDateString('es-ES', {weekday:'long', day:'numeric'})}</h2>
                                <div className="text-5xl font-black text-slate-800 mb-1">{getCycleDay(toKey(new Date())) || '?'}</div>
                                <div className="text-sm text-slate-500 mb-4">D√≠a del Ciclo</div>
                                <div className={`inline-block px-4 py-1 rounded-full text-sm font-bold ${getPhase(toKey(new Date()))?.light || 'bg-gray-100'} ${getPhase(toKey(new Date()))?.text || 'text-gray-500'}`}>{getPhase(toKey(new Date()))?.l || 'Sin datos'}</div>
                            </div>
                            {renderCalendar()}
                        </div>
                    ) : view === 'report' ? (
                        <div className="max-w-md mx-auto p-6 space-y-6 animate-in pb-24">
                            <div className="flex justify-between"><button onClick={()=>setView('calendar')}><Svg d={Icons.Left} c="w-6 h-6"/></button><h2 className="text-xl font-bold">Salud & IA</h2></div>
                            <div className={`p-6 rounded-3xl border ${dark?'bg-slate-900 border-slate-800':'bg-white shadow-sm'}`}>
                                <div className="flex gap-2 items-center text-indigo-500 font-bold mb-2"><Svg d={Icons.Sparkles} c="w-5 h-5"/> Lunea AI</div>
                                {getInsights().map((t,i)=><p key={i} className="text-sm text-slate-600 mb-1">‚Ä¢ {t}</p>)}
                            </div>
                            <button onClick={()=>setView('pdf')} className={`w-full py-3 rounded-xl font-bold ${theme.light} ${theme.text} flex justify-center gap-2`}><Svg d={Icons.FileText} c="w-5 h-5"/> Ver Reporte PDF</button>
                            <div className={`p-6 rounded-3xl border ${dark?'bg-slate-900 border-slate-800':'bg-white shadow-sm'}`}>
                                <h3 className="font-bold mb-2">Temperatura</h3>
                                <SimpleChart data={Object.keys(user.logs).sort().slice(-14).map(k=>({val: user.logs[k].temp})).filter(x=>x.val)} color="#f43f5e" minVal={35} maxVal={38} />
                            </div>
                            <div className={`p-6 rounded-3xl border ${dark?'bg-slate-900 border-slate-800':'bg-white shadow-sm'}`}>
                                <h3 className="font-bold mb-2">Peso</h3>
                                <SimpleChart data={Object.keys(user.logs).sort().slice(-14).map(k=>({val: user.logs[k].weight})).filter(x=>x.val)} color="#14b8a6" minVal={40} maxVal={100} />
                            </div>
                        </div>
                    ) : view === 'year' ? renderYear() : (
                        <div className="p-6 max-w-md mx-auto animate-in">
                            <div className="flex justify-between mb-6"><button onClick={()=>setView('calendar')}><Svg d={Icons.Left} c="w-6 h-6"/></button><h2 className="text-xl font-bold">Ajustes</h2><div/></div>
                            <div className={`p-4 rounded-xl mb-4 ${dark?'bg-slate-900':'bg-white shadow-sm'}`}>
                                <div className="flex justify-between mb-4 font-bold"><h3>Usuarios</h3><button onClick={handleAddUser}><Svg d={Icons.Plus} c="w-5 h-5"/></button></div>
                                {db.users.map(u=><div key={u.id} className="flex justify-between items-center py-2 border-b last:border-0">
                                    <button onClick={()=>setDb({...db, currentUserId:u.id})} className={u.id===db.currentUserId?'text-rose-500 font-bold':''}>{u.name}</button>
                                    <div className="flex gap-2">
                                        <button onClick={()=>handleEditUser(u.id)} className="text-slate-400"><Svg d={Icons.Edit} c="w-4 h-4"/></button>
                                        {db.users.length>1 && <button onClick={()=>handleDeleteUser(u.id)} className="text-red-400"><Svg d={Icons.Trash} c="w-4 h-4"/></button>}
                                    </div>
                                </div>)}
                            </div>
                            <div className={`p-4 rounded-xl mb-4 ${dark?'bg-slate-900':'bg-white shadow-sm'}`}>
                                <h3 className="font-bold mb-4">Ciclo</h3>
                                <div className="space-y-4 text-sm">
                                    <div><label>Inicio</label><input type="date" value={user.config.lastPeriod} onChange={(e)=>updateConfig('lastPeriod', e.target.value)} className="border p-1 rounded ml-2"/></div>
                                    <div className="flex gap-4">
                                        <label>Ciclo <input type="number" value={user.config.cycleLen} onChange={(e)=>updateConfig('cycleLen', parseInt(e.target.value))} className="border p-1 rounded w-12"/></label>
                                        <label>Periodo <input type="number" value={user.config.periodLen} onChange={(e)=>updateConfig('periodLen', parseInt(e.target.value))} className="border p-1 rounded w-12"/></label>
                                    </div>
                                    <button onClick={()=>{ alert("Guardado"); setView('calendar'); }} className="w-full py-2 rounded text-white font-bold bg-green-500 mt-2 shadow-lg">Guardar Cambios</button>
                                </div>
                            </div>
                            <div className={`p-4 rounded-xl mb-4 ${dark?'bg-slate-900':'bg-white shadow-sm'}`}>
                                <h3 className="font-bold mb-3">Datos y App</h3>
                                <div className="flex gap-2 mb-4">{Object.keys(THEMES).map(k=><button key={k} onClick={()=>setDb({...db, theme:k})} className={`w-6 h-6 rounded-full ${THEMES[k].bg} ${db.theme===k?'ring-2 ring-gray-400':''}`}/>)}</div>
                                <div className="flex justify-between items-center mb-4">
                                    {db.pin ? <button onClick={()=>setDb({...db, pin:null})} className="text-red-500">Quitar PIN</button> : <button onClick={()=>setShowPinSetup(true)} className="text-indigo-500 font-bold">Poner PIN</button>}
                                    <button onClick={()=>setDb({...db, showTutorial:true})} className="underline">Ver Tutorial</button>
                                </div>
                                <div className="flex gap-2 text-xs"><button onClick={handleExport} className="flex-1 py-2 border rounded">Exportar</button><button onClick={()=>fileRef.current.click()} className="flex-1 py-2 border rounded">Importar</button><input type="file" ref={fileRef} onChange={handleImport} className="hidden"/></div>
                            </div>
                        </div>
                    )}

                    {/* NAV */}
                    {view !== 'pdf' && (
                        <div className="fixed bottom-0 w-full bg-white border-t p-2 flex justify-around z-40 no-print">
                            <button onClick={()=>setView('calendar')} className={view==='calendar'?'text-rose-500':'text-slate-400'}><Svg d={Icons.Calendar} c="w-6 h-6"/></button>
                            <button onClick={()=>setView('year')} className={view==='year'?'text-rose-500':'text-slate-400'}><Svg d={Icons.Grid} c="w-6 h-6"/></button>
                            <button onClick={()=>setView('report')} className={view==='report'?'text-rose-500':'text-slate-400'}><Svg d={Icons.Activity} c="w-6 h-6"/></button>
                        </div>
                    )}

                    {/* MODAL */}
                    {selDay && (
                        <div className="fixed inset-0 z-50 bg-black/60 flex items-end justify-center animate-in" onClick={()=>setSelDay(null)}>
                            <div className="w-full max-w-sm bg-white rounded-t-3xl p-6 h-[85vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-bold capitalize">{selDay.d.toLocaleDateString('es-ES',{weekday:'long',day:'numeric'})}</h3>
                                    <button onClick={()=>setSelDay(null)} className="p-2 bg-gray-100 rounded-full">‚úï</button>
                                </div>

                                {/* SALUD COMPLETA */}
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div className="bg-blue-50 p-4 rounded-xl flex flex-col items-center">
                                        <div className="text-blue-500 font-bold text-xs mb-2 flex gap-1"><Svg d={Icons.Droplet} c="w-4 h-4"/> AGUA</div>
                                        <div className="flex items-center gap-3">
                                            <button onClick={()=>updateLog(selDay.k,'water',Math.max(0,(user.logs[selDay.k]?.water||0)-1))} className="w-8 h-8 bg-white rounded-full font-bold shadow">-</button>
                                            <span className="font-bold text-xl">{user.logs[selDay.k]?.water||0}</span>
                                            <button onClick={()=>updateLog(selDay.k,'water',(user.logs[selDay.k]?.water||0)+1)} className="w-8 h-8 bg-blue-500 text-white rounded-full font-bold shadow">+</button>
                                        </div>
                                    </div>
                                    <div className="bg-indigo-50 p-4 rounded-xl flex flex-col items-center">
                                        <div className="text-indigo-500 font-bold text-xs mb-2 flex gap-1"><Svg d={Icons.Moon} c="w-4 h-4"/> SUE√ëO</div>
                                        <div className="flex items-center gap-3">
                                            <button onClick={()=>updateLog(selDay.k,'sleep',Math.max(0,(user.logs[selDay.k]?.sleep||0)-1))} className="w-8 h-8 bg-white rounded-full font-bold shadow">-</button>
                                            <span className="font-bold text-xl">{user.logs[selDay.k]?.sleep||0}h</span>
                                            <button onClick={()=>updateLog(selDay.k,'sleep',(user.logs[selDay.k]?.sleep||0)+1)} className="w-8 h-8 bg-indigo-500 text-white rounded-full font-bold shadow">+</button>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-4 mb-4">
                                    <button onClick={()=>updateLog(selDay.k,'pill',!user.logs[selDay.k]?.pill)} className={`flex-1 p-4 rounded-xl flex items-center justify-center gap-2 border ${user.logs[selDay.k]?.pill?'bg-green-100 border-green-500 text-green-700':'border-slate-100'}`}>
                                        {user.logs[selDay.k]?.pill?<Svg d={Icons.Check} c="w-5 h-5"/>:<Svg d={Icons.Pill} c="w-5 h-5"/>} <span className="font-bold text-sm">Pastilla</span>
                                    </button>
                                    <div className="flex-1 p-4 rounded-xl flex items-center justify-between border border-slate-100">
                                        <Svg d={Icons.Scale} c="w-5 h-5 opacity-50"/><input type="number" placeholder="Kg" value={user.logs[selDay.k]?.weight||''} onChange={(e)=>updateLog(selDay.k,'weight',e.target.value)} className="w-16 text-right font-bold outline-none"/>
                                    </div>
                                </div>

                                <div className="p-4 rounded-xl mb-4 flex items-center justify-between border border-slate-100">
                                    <div className="flex gap-2 text-rose-400 font-bold text-sm"><Svg d={Icons.Thermo} c="w-5 h-5"/> Temp</div>
                                    <input type="number" step="0.1" placeholder="36.5" value={user.logs[selDay.k]?.temp||''} onChange={(e)=>updateLog(selDay.k,'temp',e.target.value)} className="w-20 text-right font-bold text-lg outline-none"/>
                                </div>

                                <div className="mb-4">
                                    <label className="text-xs font-bold text-slate-400 mb-2 block">NOTAS</label>
                                    <textarea className="w-full p-3 rounded-xl border border-slate-200 outline-none" rows="2" placeholder="¬øC√≥mo te sientes?" value={user.logs[selDay.k]?.notes||''} onChange={(e)=>updateLog(selDay.k,'notes',e.target.value)}></textarea>
                                </div>

                                <div className="grid grid-cols-4 gap-2">
                                    {SYMPTOMS.map(s => {
                                        const active = (user.logs[selDay.k]?.symptoms||[]).includes(s.id);
                                        const SIcon = s.I;
                                        return <button key={s.id} onClick={()=>{const curr=user.logs[selDay.k]?.symptoms||[]; updateLog(selDay.k,'symptoms',active?curr.filter(x=>x!==s.id):[...curr,s.id])}} className={`p-3 rounded-xl border flex flex-col items-center gap-1 ${active?`${theme.light} border-transparent ${theme.text}`:(dark?'border-slate-700':'border-slate-100')}`}><Svg d={SIcon} c="w-6 h-6"/><span className="text-[10px] font-medium">{s.label}</span></button>
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    <footer className="text-center py-6 text-xs opacity-40 no-print pb-24"><p>Creado por ‚ù§Ô∏è Juan Miguel Rios Redondo ‚ù§Ô∏è</p></footer>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
